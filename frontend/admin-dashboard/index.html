<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AXKAN - Panel de Administraci√≥n</title>
    <link rel="icon" type="image/png" href="../assets/images/LOGO-01.png">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        // Authentication check - runs before page loads
        (function() {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                // No token, redirect to login
                window.location.href = 'login.html';
            }
        })();
    </script>
</head>
<body>
    <!-- Header -->
    <header class="dashboard-header">
        <div class="header-content">
            <div class="logo-area">
                <img src="../assets/images/LOGO-01.png" alt="AXKAN" class="logo-image" style="height: 48px; width: auto;">
                <div>
                    <h1>AXKAN</h1>
                    <p class="subtitle">Panel de Administraci√≥n</p>
                </div>
            </div>
            <div class="header-stats">
                <div class="stat-card">
                    <span class="stat-label">Pedidos Pendientes</span>
                    <span class="stat-value" id="pending-count">0</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Total Hoy</span>
                    <span class="stat-value" id="today-revenue">$0</span>
                </div>
                <div class="stat-card" style="position: relative;">
                    <span class="stat-label">üí≥ Pagos Finales</span>
                    <span class="stat-value" id="second-payment-badge" style="display: none; background: #fb923c; color: white; padding: 8px 16px; border-radius: 12px; font-size: 20px; font-weight: 700;">0</span>
                </div>
                <button onclick="logout()" style="padding: 10px 20px; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; color: white; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    üö™ Cerrar Sesi√≥n
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="dashboard-main">
        <!-- Sidebar -->
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <button class="nav-item active" data-view="orders">
                    <span class="nav-icon">üìã</span>
                    <span>Pedidos</span>
                </button>
                <button class="nav-item" data-view="analytics">
                    <span class="nav-icon">üìä</span>
                    <span>Anal√≠ticas</span>
                </button>
                <button class="nav-item" data-view="products">
                    <span class="nav-icon">üõçÔ∏è</span>
                    <span>Productos</span>
                </button>
                <button class="nav-item" data-view="prices">
                    <span class="nav-icon">üí∞</span>
                    <span>Precios</span>
                </button>
                <button class="nav-item" data-view="shipping">
                    <span class="nav-icon">üì¶</span>
                    <span>Env√≠os</span>
                </button>
            </nav>
        </aside>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Orders View -->
            <section id="orders-view" class="view active">
                <!-- Order Alerts Widget -->
                <div id="order-alerts-widget" class="alerts-widget" style="margin-bottom: 20px;">
                    <!-- Dynamic content loaded by JS -->
                </div>

                <!-- Filters -->
                <div class="filters-bar">
                    <div class="filter-group">
                        <button class="filter-btn active" data-filter="all">
                            Todos <span class="badge" id="all-count">0</span>
                        </button>
                        <button class="filter-btn" data-filter="pending_review">
                            ‚è≥ Pendientes <span class="badge badge-warning" id="pending-count-badge">0</span>
                        </button>
                        <button class="filter-btn" data-filter="approved">
                            ‚úÖ Aprobados <span class="badge badge-success" id="approved-count">0</span>
                        </button>
                        <button class="filter-btn" data-filter="completed">
                            üì¶ Completados <span class="badge badge-secondary" id="completed-count">0</span>
                        </button>
                    </div>
                    <div class="search-container">
                        <input
                            type="text"
                            id="search-input"
                            class="search-input"
                            placeholder="üîç Buscar por n√∫mero, cliente o tel√©fono..."
                            oninput="handleSearch(this.value)"
                        />
                        <button class="search-clear" id="search-clear" onclick="clearSearch()" style="display: none;">
                            ‚úï
                        </button>
                    </div>
                    <button class="btn-refresh" onclick="loadOrders()">
                        <span id="refresh-icon">üîÑ</span> Actualizar
                    </button>
                </div>

                <!-- Loading State -->
                <div id="orders-loading" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Cargando pedidos...</p>
                </div>

                <!-- Orders List -->
                <div id="orders-container" class="orders-list"></div>

                <!-- Empty State -->
                <div id="empty-state" class="empty-state hidden">
                    <span class="empty-icon">üì¶</span>
                    <h3>No hay pedidos</h3>
                    <p>Los pedidos aparecer√°n aqu√≠ cuando los clientes los env√≠en</p>
                </div>
            </section>

            <!-- Order Detail Modal -->
            <div id="order-detail-modal" class="modal hidden">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="modal-title">Detalles del Pedido</h2>
                        <button class="modal-close" onclick="closeOrderDetail()">√ó</button>
                    </div>
                    <div class="modal-body" id="modal-body">
                        <!-- Content loaded dynamically -->
                    </div>
                </div>
                <div class="modal-backdrop" onclick="closeOrderDetail()"></div>
            </div>

            <!-- Client Lookup Modal -->
            <div id="client-lookup-modal" class="modal hidden">
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2>üìû Buscar Pedidos del Cliente</h2>
                        <button class="modal-close" onclick="closeClientLookup()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 20px;">
                            <label for="lookup-phone" style="display: block; margin-bottom: 8px; font-weight: 600;">Tel√©fono:</label>
                            <input type="tel" id="lookup-phone" placeholder="5512345678" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" />
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label for="lookup-email" style="display: block; margin-bottom: 8px; font-weight: 600;">Email (opcional):</label>
                            <input type="email" id="lookup-email" placeholder="cliente@example.com" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" />
                        </div>
                        <button onclick="lookupClientOrders()" class="btn btn-primary" style="width: 100%; padding: 14px; font-size: 16px; font-weight: 600;">
                            üîç Buscar Mis Pedidos
                        </button>

                        <!-- Loading State -->
                        <div id="lookup-loading" class="hidden" style="text-align: center; margin-top: 20px;">
                            <div class="spinner" style="margin: 0 auto;"></div>
                            <p style="margin-top: 12px; color: #6b7280;">Buscando pedidos...</p>
                        </div>

                        <!-- Results Container -->
                        <div id="lookup-results" class="hidden" style="margin-top: 24px;">
                            <div style="border-top: 2px solid #e5e7eb; padding-top: 20px;">
                                <h3 style="margin-bottom: 16px; font-size: 18px; color: #111827;">Pedidos Encontrados</h3>
                                <div id="lookup-orders-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-backdrop" onclick="closeClientLookup()"></div>
            </div>

            <!-- Deposit Confirmation Modal -->
            <div id="deposit-confirmation-modal" class="modal hidden">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2>üíµ Confirmar Anticipo Recibido</h2>
                        <button class="modal-close" onclick="closeDepositModal()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3B82F6;">
                            <div style="margin-bottom: 8px;">
                                <span style="font-weight: 600; color: #6b7280;">Orden:</span>
                                <span id="deposit-order-number" style="font-weight: 700; color: #111827; margin-left: 8px;"></span>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <span style="font-weight: 600; color: #6b7280;">Cliente:</span>
                                <span id="deposit-client-name" style="font-weight: 700; color: #111827; margin-left: 8px;"></span>
                            </div>
                            <div>
                                <span style="font-weight: 600; color: #6b7280;">Total del Pedido:</span>
                                <span id="deposit-total-price" style="font-weight: 700; color: #111827; margin-left: 8px;"></span>
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label for="actual-deposit-amount" style="display: block; margin-bottom: 8px; font-weight: 600; color: #111827;">
                                Monto del Anticipo Recibido (MXN):
                            </label>
                            <div style="position: relative;">
                                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-weight: 600; color: #6b7280;">$</span>
                                <input
                                    type="number"
                                    id="actual-deposit-amount"
                                    placeholder="0.00"
                                    step="0.01"
                                    min="0"
                                    style="width: 100%; padding: 12px 12px 12px 28px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 18px; font-weight: 600;"
                                />
                            </div>
                            <p style="margin-top: 8px; font-size: 13px; color: #6b7280;">
                                Ingresa el monto exacto del anticipo que recibiste del cliente
                            </p>
                        </div>

                        <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
                            <p style="margin: 0; font-size: 13px; color: #92400e;">
                                <strong>Nota:</strong> Se generar√° un recibo PDF con este monto y se enviar√° autom√°ticamente al cliente por correo electr√≥nico.
                            </p>
                        </div>

                        <div style="display: flex; gap: 12px;">
                            <button onclick="closeDepositModal()" class="btn btn-secondary" style="flex: 1; padding: 12px;">
                                Cancelar
                            </button>
                            <button onclick="confirmApproveWithDeposit()" class="btn btn-success" style="flex: 1; padding: 12px;">
                                ‚úÖ Aprobar y Generar Recibo
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-backdrop" onclick="closeDepositModal()"></div>
            </div>

            <!-- Analytics View -->
            <section id="analytics-view" class="view">
                <div class="view-header">
                    <h2>üìä Anal√≠ticas</h2>
                    <div class="analytics-actions">
                        <button class="btn" onclick="exportAnalyticsCSV()">
                            üì• Exportar CSV
                        </button>
                        <button class="btn btn-primary" onclick="loadAnalyticsData()">
                            üîÑ Actualizar
                        </button>
                    </div>
                </div>

                <!-- Date Range Filters -->
                <div class="analytics-filters">
                    <div class="quick-ranges">
                        <button class="quick-range-btn" data-days="7" onclick="setQuickDateRange(7)">7 d√≠as</button>
                        <button class="quick-range-btn active" data-days="30" onclick="setQuickDateRange(30)">30 d√≠as</button>
                        <button class="quick-range-btn" data-days="90" onclick="setQuickDateRange(90)">90 d√≠as</button>
                        <button class="quick-range-btn" data-days="365" onclick="setQuickDateRange(365)">1 a√±o</button>
                    </div>
                    <div class="date-range-inputs">
                        <div class="date-input-group">
                            <label for="analytics-start-date">Desde</label>
                            <input type="date" id="analytics-start-date" onchange="handleDateRangeChange()">
                        </div>
                        <div class="date-input-group">
                            <label for="analytics-end-date">Hasta</label>
                            <input type="date" id="analytics-end-date" onchange="handleDateRangeChange()">
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="analytics-loading" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Cargando anal√≠ticas...</p>
                </div>

                <!-- Analytics Content -->
                <div id="analytics-content" class="analytics-content">
                    <!-- Summary Cards -->
                    <div id="analytics-summary-cards" class="analytics-summary-cards">
                        <!-- Dynamic KPI cards -->
                    </div>

                    <!-- Charts Row 1: Revenue over time -->
                    <div class="analytics-section">
                        <div class="section-header">
                            <h3>üìà Ingresos y Ganancia</h3>
                        </div>
                        <div class="chart-container large">
                            <canvas id="revenue-chart"></canvas>
                        </div>
                    </div>

                    <!-- Charts Row 2: Pie charts side by side -->
                    <div class="analytics-row">
                        <div class="analytics-section half">
                            <div class="section-header">
                                <h3>üõçÔ∏è Ventas por Categor√≠a</h3>
                            </div>
                            <div class="chart-container medium">
                                <canvas id="products-pie-chart"></canvas>
                            </div>
                        </div>
                        <div class="analytics-section half">
                            <div class="section-header">
                                <h3>üìã Estado de Pedidos</h3>
                            </div>
                            <div class="chart-container medium">
                                <canvas id="status-pie-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row 3: Top products and clients -->
                    <div class="analytics-row">
                        <div class="analytics-section half">
                            <div class="section-header">
                                <h3>üèÜ Productos M√°s Vendidos</h3>
                            </div>
                            <div id="top-products-list" class="ranking-list">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                        <div class="analytics-section half">
                            <div class="section-header">
                                <h3>üë• Mejores Clientes</h3>
                            </div>
                            <div id="top-clients-list" class="ranking-list">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row 4: Revenue by city -->
                    <div class="analytics-section">
                        <div class="section-header">
                            <h3>üó∫Ô∏è Ingresos por Ciudad</h3>
                        </div>
                        <div class="chart-container medium">
                            <canvas id="city-chart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Products / Inventory View -->
            <section id="products-view" class="view">
                <div class="view-header">
                    <h2>üì¶ Inventario de Materiales</h2>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="showQuickReceiveModal()">
                            ‚ö° Quick Receive
                        </button>
                        <button class="btn btn-primary" onclick="showInvoiceUploadModal()">
                            üì∏ Upload Invoice
                        </button>
                        <button class="btn" onclick="showPrintLabelsModal()">
                            üè∑Ô∏è Print Labels
                        </button>
                        <button class="btn" onclick="printSmartBarcodes()" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; font-weight: 700;">
                            üè∑Ô∏èüìä Print Smart Barcodes
                        </button>
                        <button class="btn btn-primary" onclick="showAddMaterialModal()">
                            ‚ûï Add Material
                        </button>
                    </div>
                </div>

                <!-- Alert Summary -->
                <div id="alert-summary" class="alert-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <!-- Dynamic content -->
                </div>

                <!-- Loading State -->
                <div id="inventory-loading" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Cargando inventario...</p>
                </div>

                <!-- Materials Grid -->
                <div id="materials-container" class="materials-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                    <!-- Dynamic content -->
                </div>

                <!-- Empty State -->
                <div id="inventory-empty-state" class="empty-state hidden">
                    <span class="empty-icon">üì¶</span>
                    <h3>No hay materiales</h3>
                    <p>Agrega tu primer material para comenzar a gestionar el inventario</p>
                </div>
            </section>

            <!-- Prices View -->
            <section id="prices-view" class="view">
                <div class="view-header">
                    <h2>üí∞ Precios y M√°rgenes</h2>
                    <div style="display: flex; gap: 12px;">
                        <select id="price-period-select" onchange="loadPriceDashboard(this.value)" style="padding: 10px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-weight: 600;">
                            <option value="7">√öltimos 7 d√≠as</option>
                            <option value="30" selected>√öltimos 30 d√≠as</option>
                            <option value="90">√öltimos 90 d√≠as</option>
                            <option value="180">√öltimos 6 meses</option>
                        </select>
                        <button class="btn btn-primary" onclick="refreshPriceTrends()">
                            üîÑ Actualizar
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="prices-loading" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Cargando datos de precios...</p>
                </div>

                <!-- Summary Cards -->
                <div id="price-summary-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 24px;">
                    <!-- Dynamic content -->
                </div>

                <!-- Alerts Section -->
                <div id="price-alerts" style="margin-bottom: 24px;">
                    <!-- Dynamic content -->
                </div>

                <!-- Tabs for different views -->
                <div class="price-tabs" style="margin-bottom: 20px;">
                    <button class="price-tab-btn active" data-tab="overview" onclick="switchPriceTab('overview')">
                        üìä Resumen
                    </button>
                    <button class="price-tab-btn" data-tab="bom" onclick="switchPriceTab('bom')">
                        üîß Componentes (BOM)
                    </button>
                </div>

                <!-- Overview Tab -->
                <div id="price-tab-overview" class="price-tab-content active">
                    <div class="card">
                        <h3 style="margin: 0 0 16px 0;">üèÜ Productos</h3>
                        <div id="top-products-table">
                            <!-- Table will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- BOM Tab -->
                <div id="price-tab-bom" class="price-tab-content">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                        <!-- Raw Materials Section -->
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 style="margin: 0;">üì¶ Materiales Disponibles</h3>
                                <button class="btn btn-primary" onclick="openAddMaterialModal()">+ Agregar Material</button>
                            </div>
                            <div id="raw-materials-list">
                                <!-- Materials will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="prices-empty-state" class="empty-state hidden">
                    <span class="empty-icon">üí∞</span>
                    <h3>No hay datos de precios</h3>
                    <p>Los datos aparecer√°n cuando haya productos con historial de precios</p>
                </div>
            </section>

            <!-- Shipping/Env√≠os View -->
            <section id="shipping-view" class="view">
                <div class="view-header">
                    <h2>üì¶ Base de Datos de Env√≠os</h2>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-primary" onclick="showAddClientModal()">
                            ‚ûï Agregar Cliente
                        </button>
                        <button class="btn" onclick="exportClientsCSV()">
                            üì• Exportar CSV
                        </button>
                    </div>
                </div>

                <!-- Search and Filters Bar -->
                <div class="shipping-filters-bar">
                    <div class="shipping-search-container">
                        <span class="search-icon">üîç</span>
                        <input type="text" id="shipping-search-input" class="shipping-search-input"
                            placeholder="Buscar por nombre, tel√©fono, ciudad..."
                            oninput="handleShippingSearch(this.value)" />
                        <button class="search-clear" id="shipping-search-clear" onclick="clearShippingSearch()" style="display: none;">‚úï</button>
                    </div>

                    <!-- Filter Chips -->
                    <div class="filter-chips" id="filter-chips">
                        <button class="filter-chip" onclick="toggleFilterDropdown('city')">
                            <span>Ciudad</span>
                            <span class="chip-arrow">‚ñº</span>
                        </button>
                        <button class="filter-chip" onclick="toggleFilterDropdown('state')">
                            <span>Estado</span>
                            <span class="chip-arrow">‚ñº</span>
                        </button>
                        <button class="filter-chip" onclick="toggleFilterDropdown('hasAddress')">
                            <span>Con Direcci√≥n</span>
                            <span class="chip-arrow">‚ñº</span>
                        </button>
                    </div>

                    <!-- Active Filters Display -->
                    <div class="active-filters" id="active-filters"></div>
                </div>

                <!-- Filter Dropdown -->
                <div id="filter-dropdown" class="filter-dropdown hidden">
                    <div class="filter-dropdown-content" id="filter-dropdown-content"></div>
                </div>

                <!-- Stats Summary -->
                <div class="shipping-stats" id="shipping-stats">
                    <div class="stat-item">
                        <span class="stat-number" id="total-clients">0</span>
                        <span class="stat-label">Total Clientes</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="clients-with-address">0</span>
                        <span class="stat-label">Con Direcci√≥n</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="unique-cities">0</span>
                        <span class="stat-label">Ciudades</span>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="shipping-loading" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Cargando clientes...</p>
                </div>

                <!-- Clients Table -->
                <div class="shipping-table-container">
                    <table class="shipping-table" id="shipping-table">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortShippingTable('name')">Nombre <span class="sort-icon" data-col="name"></span></th>
                                <th class="sortable" onclick="sortShippingTable('phone')">Tel√©fono <span class="sort-icon" data-col="phone"></span></th>
                                <th class="sortable" onclick="sortShippingTable('email')">Email <span class="sort-icon" data-col="email"></span></th>
                                <th class="sortable" onclick="sortShippingTable('address')">Direcci√≥n <span class="sort-icon" data-col="address"></span></th>
                                <th class="sortable" onclick="sortShippingTable('city')">Ciudad <span class="sort-icon" data-col="city"></span></th>
                                <th class="sortable" onclick="sortShippingTable('state')">Estado <span class="sort-icon" data-col="state"></span></th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="shipping-table-body"></tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="shipping-empty-state" class="empty-state hidden">
                    <span class="empty-icon">üì¶</span>
                    <h3>No hay clientes</h3>
                    <p>Los clientes aparecer√°n aqu√≠ cuando env√≠en pedidos</p>
                </div>

                <!-- Pagination -->
                <div class="shipping-pagination" id="shipping-pagination">
                    <button class="pagination-btn" onclick="goToShippingPage('prev')" id="prev-page-btn">‚Üê Anterior</button>
                    <span class="pagination-info" id="pagination-info">P√°gina 1 de 1</span>
                    <button class="pagination-btn" onclick="goToShippingPage('next')" id="next-page-btn">Siguiente ‚Üí</button>
                </div>
            </section>
        </div>
    </main>

    <!-- Material Detail Modal -->
    <div id="material-detail-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="material-modal-title">Material</h2>
                <button class="modal-close" onclick="closeMaterialDetail()">√ó</button>
            </div>
            <div class="modal-body" id="material-modal-body">
                <!-- Dynamic content -->
            </div>
        </div>
        <div class="modal-backdrop" onclick="closeMaterialDetail()"></div>
    </div>

    <!-- Add/Edit Material Modal (BOM) -->
    <div id="add-material-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="material-modal-title">Agregar Material</h2>
                <button class="modal-close" onclick="closeAddMaterialModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="material-form" onsubmit="saveMaterial(event)">
                    <input type="hidden" name="material_id" id="material_id">
                    <div style="display: grid; gap: 16px;">
                        <!-- Basic Info -->
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Nombre del Material *</label>
                                <input type="text" name="name" id="material_name" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">SKU</label>
                                <input type="text" name="sku" id="material_sku" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Descripci√≥n</label>
                            <textarea name="description" id="material_description" rows="2" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;"></textarea>
                        </div>

                        <!-- Unit Type -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Tipo de Unidad *</label>
                                <select name="unit_type" id="material_unit_type" required onchange="handleUnitTypeChange(this.value)" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                    <option value="">-- Seleccionar --</option>
                                    <option value="piece">Piezas (piece)</option>
                                    <option value="area">√Årea (cm¬≤)</option>
                                    <option value="weight">Peso (gramos)</option>
                                    <option value="length">Longitud (metros)</option>
                                    <option value="volume">Volumen (litros)</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Etiqueta de Unidad</label>
                                <input type="text" name="unit_label" id="material_unit_label" placeholder="ej: piezas, cm¬≤, gramos" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>

                        <!-- Pricing -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Costo por Unidad *</label>
                                <input type="number" name="cost_per_unit" id="material_cost_per_unit" required min="0" step="0.0001" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Tama√±o de Compra</label>
                                <input type="number" name="purchase_unit_size" id="material_purchase_unit_size" min="0" step="0.01" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Costo de Compra</label>
                                <input type="number" name="purchase_unit_cost" id="material_purchase_unit_cost" min="0" step="0.01" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>

                        <!-- Area Fields (for sheets like MDF) -->
                        <div id="area-fields" style="display: none;">
                            <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; border: 2px solid #bfdbfe;">
                                <h4 style="margin: 0 0 12px 0; color: #1e40af;">Dimensiones de Hoja/L√°mina</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ancho (cm)</label>
                                        <input type="number" name="sheet_width" id="material_sheet_width" min="0" step="0.01" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Alto (cm)</label>
                                        <input type="number" name="sheet_height" id="material_sheet_height" min="0" step="0.01" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Supplier Info -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Proveedor</label>
                                <input type="text" name="supplier_name" id="material_supplier_name" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">C√≥digo del Proveedor</label>
                                <input type="text" name="supplier_product_code" id="material_supplier_code" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>

                        <!-- Stock -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Stock Actual</label>
                                <input type="number" name="current_stock" id="material_current_stock" min="0" step="0.01" value="0" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Stock M√≠nimo</label>
                                <input type="number" name="min_stock_level" id="material_min_stock" min="0" step="0.01" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px; margin-top: 16px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">Guardar Material</button>
                            <button type="button" onclick="closeAddMaterialModal()" class="btn" style="flex: 1; background: #e5e7eb; color: #374151;">Cancelar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="modal-backdrop" onclick="closeAddMaterialModal()"></div>
    </div>

    <!-- Add Component Modal -->
    <div id="add-component-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Agregar Componente</h2>
                <button class="modal-close" onclick="closeAddComponentModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="component-form" onsubmit="saveComponent(event)">
                    <input type="hidden" name="product_id" id="component_product_id">
                    <input type="hidden" name="component_id" id="component_id">
                    <div style="display: grid; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Material *</label>
                            <select name="raw_material_id" id="component_material_id" required onchange="handleMaterialSelection(this.value)" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                <option value="">-- Seleccionar material --</option>
                            </select>
                        </div>

                        <div id="component-quantity-section">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Cantidad Necesaria *</label>
                            <input type="number" name="quantity_needed" id="component_quantity" required min="0" step="0.0001" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            <small id="unit-hint" style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;"></small>
                        </div>

                        <!-- Area-based fields -->
                        <div id="component-area-fields" style="display: none;">
                            <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; border: 2px solid #bfdbfe;">
                                <h4 style="margin: 0 0 12px 0; color: #1e40af;">Dimensiones de Pieza</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ancho (cm)</label>
                                        <input type="number" name="piece_width" id="component_piece_width" min="0" step="0.01" onchange="calculateAreaCost()" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Alto (cm)</label>
                                        <input type="number" name="piece_height" id="component_piece_height" min="0" step="0.01" onchange="calculateAreaCost()" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                    </div>
                                </div>
                                <div id="area-cost-preview" style="margin-top: 12px; padding: 12px; background: white; border-radius: 6px; font-size: 14px;"></div>
                            </div>
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Porcentaje de Desperdicio (%)</label>
                            <input type="number" name="waste_percentage" id="component_waste" min="0" max="100" step="0.01" value="5.00" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            <small style="color: #6b7280; font-size: 12px;">Desperdicio estimado por corte, merma, etc.</small>
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Notas</label>
                            <textarea name="notes" id="component_notes" rows="2" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;"></textarea>
                        </div>

                        <div style="display: flex; gap: 12px; margin-top: 16px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">Guardar Componente</button>
                            <button type="button" onclick="closeAddComponentModal()" class="btn" style="flex: 1; background: #e5e7eb; color: #374151;">Cancelar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="modal-backdrop" onclick="closeAddComponentModal()"></div>
    </div>

    <!-- Product Detail Modal -->
    <div id="product-detail-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="product-detail-title">Detalles del Producto</h2>
                <button class="modal-close" onclick="closeProductDetailModal()">√ó</button>
            </div>
            <div class="modal-body" id="product-detail-body">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
        <div class="modal-backdrop" onclick="closeProductDetailModal()"></div>
    </div>

    <!-- Invoice Upload Modal -->
    <div id="invoice-upload-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì∏ Upload Invoice</h2>
                <button class="modal-close" onclick="closeInvoiceUploadModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; padding: 40px; border: 3px dashed #d1d5db; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#6366f1'; this.style.background='#f0f9ff'" onmouseout="this.style.borderColor='#d1d5db'; this.style.background=''">
                        <input type="file" id="invoice-file-input" accept="image/*" onchange="handleInvoiceFileSelect(event)" style="display: none;">
                        <div style="font-size: 48px; margin-bottom: 12px;">üìÑ</div>
                        <div style="font-weight: 600; margin-bottom: 8px;">Click to upload invoice image</div>
                        <div style="font-size: 14px; color: #6b7280;">or drag and drop</div>
                        <div style="font-size: 12px; color: #9ca3af; margin-top: 8px;">PNG, JPG, PDF up to 50MB</div>
                    </label>
                </div>
                <div id="invoice-preview" style="margin-bottom: 20px; text-align: center;"></div>
                <button id="invoice-upload-btn" onclick="handleInvoiceUpload()" class="btn btn-success" style="width: 100%;" disabled>
                    Process Invoice
                </button>
            </div>
        </div>
        <div class="modal-backdrop" onclick="closeInvoiceUploadModal()"></div>
    </div>

    <!-- Invoice Review Modal -->
    <div id="invoice-review-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>üìã Review Invoice</h2>
                <button class="modal-close" onclick="closeInvoiceReviewModal()">√ó</button>
            </div>
            <div class="modal-body" id="invoice-review-body">
                <!-- Dynamic content -->
            </div>
        </div>
        <div class="modal-backdrop" onclick="closeInvoiceReviewModal()"></div>
    </div>

    <!-- Print Labels Modal -->
    <div id="print-labels-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üè∑Ô∏è Print Labels</h2>
                <button class="modal-close" onclick="closePrintLabelsModal()">√ó</button>
            </div>
            <div class="modal-body" id="print-labels-body">
                <!-- Dynamic content -->
            </div>
        </div>
        <div class="modal-backdrop" onclick="closePrintLabelsModal()"></div>
    </div>

    <!-- Quick Receive Modal -->
    <div id="quick-receive-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2>‚ö° Quick Receive Mode</h2>
                <button class="modal-close" onclick="closeQuickReceiveModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <!-- Left Panel: Scanner Input -->
                    <div>
                        <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="margin: 0 0 16px 0; font-size: 18px;">Scan Barcode</h3>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">Barcode</label>
                                <input
                                    type="text"
                                    id="quick-barcode-input"
                                    onkeypress="handleQuickReceiveScan(event)"
                                    placeholder="Scan or type barcode..."
                                    style="width: 100%; padding: 16px; border: 3px solid #3b82f6; border-radius: 8px; font-size: 20px; font-family: monospace; text-transform: uppercase;"
                                    autocomplete="off">
                            </div>
                            <div id="quick-material-info" style="margin-bottom: 16px;">
                                <!-- Material info appears here -->
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">Quantity</label>
                                <input
                                    type="number"
                                    id="quick-quantity-input"
                                    onkeypress="handleQuickReceiveQuantity(event)"
                                    placeholder="Enter quantity..."
                                    style="width: 100%; padding: 16px; border: 3px solid #10b981; border-radius: 8px; font-size: 20px;"
                                    step="0.01"
                                    autocomplete="off">
                            </div>
                            <div style="margin-top: 20px; padding: 16px; background: #fef3c7; border-radius: 8px; font-size: 14px;">
                                <strong>Instructions:</strong><br>
                                1. Scan barcode or type and press Enter<br>
                                2. Enter quantity and press Enter<br>
                                3. Repeat for next item
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel: Session History -->
                    <div>
                        <h3 style="margin: 0 0 16px 0; font-size: 18px;">Recent Transactions</h3>
                        <div id="quick-receive-history" style="max-height: 500px; overflow-y: auto;">
                            <!-- Transaction history appears here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop" onclick="closeQuickReceiveModal()"></div>
    </div>

    <script src="dashboard.js"></script>
    <script src="inventory.js"></script>
    <script src="prices.js"></script>
    <script src="shipping.js"></script>
    <script src="analytics.js"></script>
</body>
</html>
