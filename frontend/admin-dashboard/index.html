<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AXKAN - Panel de Administraci√≥n</title>
    <link rel="icon" type="image/png" href="../assets/images/LOGO-01.png">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        // Authentication check - validates token with backend
        (async function() {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            // Verify token is valid with backend
            const API_BASE = window.location.hostname === 'localhost'
                ? 'http://localhost:3000/api'
                : 'https://vt-souvenir-backend.onrender.com/api';
            try {
                const response = await fetch(`${API_BASE}/admin/verify`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    localStorage.removeItem('admin_token');
                    window.location.href = 'login.html';
                }
            } catch (e) {
                console.warn('Auth verification failed, continuing with cached token');
            }
        })();
    </script>
</head>
<body>
    <!-- Header -->
    <header class="dashboard-header">
        <div class="header-content">
            <!-- Mobile Menu Button -->
            <button class="mobile-menu-btn" id="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Menu">
                <i data-lucide="menu" class="icon">‚ò∞</i>
            </button>
            <div class="logo-area">
                <img src="../assets/images/LOGO-01.png" alt="AXKAN" class="logo-image">
                <div class="logo-text">
                    <h1>AXKAN</h1>
                    <p class="subtitle">Panel de Administraci√≥n</p>
                </div>
            </div>
            <!-- Command Palette Trigger (‚åòK) -->
            <div class="command-palette-trigger" id="command-palette-trigger" onclick="openCommandPalette()">
                <i data-lucide="search" class="icon-sm"></i>
                <span class="command-placeholder">Buscar o ejecutar comando...</span>
                <kbd class="kbd-shortcut">‚åòK</kbd>
            </div>
            <div class="header-stats">
                <div class="stat-card">
                    <span class="stat-label">Pendientes</span>
                    <span class="stat-value" id="pending-count">0</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Hoy</span>
                    <span class="stat-value" id="today-revenue">$0</span>
                </div>
                <div class="notification-bell-wrapper" id="notification-bell-wrapper">
                    <button class="notification-bell-btn" id="notification-bell-btn" onclick="toggleNotificationCenter()" aria-label="Notificaciones">
                        <i data-lucide="bell" class="icon-sm"></i>
                        <span class="notification-badge" id="notification-badge" style="display: none;">0</span>
                    </button>
                    <div class="notification-panel hidden" id="notification-panel">
                        <div class="notif-panel-header">
                            <h3>Notificaciones</h3>
                            <button class="notif-mark-read" onclick="markAllAlertsReadAndRefresh()">Marcar todo leido</button>
                        </div>
                        <div class="notif-panel-summary" id="notif-panel-summary"></div>
                        <div class="notif-panel-list" id="notif-panel-list"></div>
                        <div class="notif-panel-footer">
                            <span class="notif-footer-text" id="notif-footer-text">Sin alertas</span>
                        </div>
                    </div>
                </div>
                <button class="btn-logout" onclick="logout()" aria-label="Cerrar sesi√≥n">
                    <i data-lucide="log-out" class="icon-sm"></i>
                    <span class="logout-text">Salir</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobile-overlay" onclick="toggleMobileMenu()"></div>

    <!-- Main Content -->
    <main class="dashboard-main">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <nav class="sidebar-nav" role="navigation" aria-label="Main navigation">
                <!-- 1. Pedidos (Orders + Calendar) -->
                <div class="nav-section">
                    <button class="nav-item active" data-view="orders" tabindex="0">
                        <i data-lucide="clipboard-list" class="nav-icon"></i>
                        <span>Pedidos</span>
                    </button>
                    <div class="nav-sub-items">
                        <button class="nav-sub-item" data-view="calendar" tabindex="0">
                            <i data-lucide="calendar" class="nav-icon-sm"></i>
                            <span>Calendario</span>
                        </button>
                    </div>
                </div>

                <!-- 2. Dashboard/Analytics -->
                <button class="nav-item" data-view="analytics" tabindex="0">
                    <i data-lucide="bar-chart-3" class="nav-icon"></i>
                    <span>Dashboard</span>
                </button>

                <!-- 3. Inventario (Products + Materials) -->
                <button class="nav-item" data-view="products" tabindex="0">
                    <i data-lucide="package" class="nav-icon"></i>
                    <span>Inventario</span>
                </button>

                <!-- 4. Finanzas (Prices + Margins + Commissions) -->
                <div class="nav-section">
                    <button class="nav-item" data-view="prices" tabindex="0">
                        <i data-lucide="wallet" class="nav-icon"></i>
                        <span>Finanzas</span>
                    </button>
                    <div class="nav-sub-items">
                        <button class="nav-sub-item" data-view="comisiones" tabindex="0">
                            <i data-lucide="percent" class="nav-icon-sm"></i>
                            <span>Comisiones</span>
                        </button>
                    </div>
                </div>

                <!-- 5. Log√≠stica (Shipping + Gu√≠as + Pickups) -->
                <div class="nav-section">
                    <button class="nav-item" data-view="shipping" tabindex="0">
                        <i data-lucide="truck" class="nav-icon"></i>
                        <span>Log√≠stica</span>
                    </button>
                    <div class="nav-sub-items">
                        <button class="nav-sub-item" data-view="guias" tabindex="0">
                            <i data-lucide="tag" class="nav-icon-sm"></i>
                            <span>Gu√≠as</span>
                        </button>
                        <button class="nav-sub-item" data-view="pickups" tabindex="0">
                            <i data-lucide="package-check" class="nav-icon-sm"></i>
                            <span>Recolecciones</span>
                        </button>
                    </div>
                </div>

                <!-- 6. Marketplace -->
                <button class="nav-item" data-view="marketplace" tabindex="0">
                    <i data-lucide="globe" class="nav-icon"></i>
                    <span>Marketplace</span>
                </button>

                <div class="nav-separator"></div>

                <!-- 7. Configuraci√≥n (Employees + Discounts + Settings) -->
                <div class="nav-section">
                    <button class="nav-item" data-view="employee-portal" tabindex="0">
                        <i data-lucide="settings" class="nav-icon"></i>
                        <span>Configuraci√≥n</span>
                    </button>
                    <div class="nav-sub-items">
                        <button class="nav-sub-item" data-view="discounts" tabindex="0">
                            <i data-lucide="percent" class="nav-icon-sm"></i>
                            <span>Descuentos</span>
                        </button>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Orders View -->
            <section id="orders-view" class="view active">
                <!-- Proactive AI Alerts Widget -->
                <div id="ai-alerts-widget" class="ai-alerts-widget">
                    <!-- Dynamic AI insights loaded by JS -->
                </div>

                <!-- Actions Bar -->
                <div class="orders-actions-bar">
                    <button class="btn-create-order" onclick="openCreateOrderModal()">
                        <i data-lucide="plus-circle" class="icon-sm"></i>
                        <span>Nuevo Pedido</span>
                    </button>
                </div>

                <!-- Filters -->
                <div class="filters-bar">
                    <div class="filter-group">
                        <button class="filter-btn active" data-filter="all">
                            Todos <span class="badge" id="all-count">0</span>
                        </button>
                        <button class="filter-btn" data-filter="pending_review">
                            <i data-lucide="clock" class="filter-icon"></i> Pendientes <span class="badge badge-warning" id="pending-count-badge">0</span>
                        </button>
                        <button class="filter-btn" data-filter="approved">
                            <i data-lucide="check-circle" class="filter-icon"></i> Aprobados <span class="badge badge-success" id="approved-count">0</span>
                        </button>
                        <button class="filter-btn" data-filter="completed">
                            <i data-lucide="package" class="filter-icon"></i> Completados <span class="badge badge-secondary" id="completed-count">0</span>
                        </button>
                    </div>
                    <div class="salesperson-filter">
                        <select id="salesperson-filter" onchange="filterBySalesperson(this.value)">
                            <option value="">üë§ Todos los vendedores</option>
                        </select>
                    </div>
                    <div class="search-container">
                        <i data-lucide="search" class="search-icon"></i>
                        <input
                            type="text"
                            id="search-input"
                            class="search-input"
                            placeholder="Buscar por n√∫mero, cliente o tel√©fono..."
                            oninput="handleSearch(this.value)"
                        />
                        <button class="search-clear hidden" id="search-clear" onclick="clearSearch()">
                            <i data-lucide="x" class="icon-xs"></i>
                        </button>
                    </div>
                    <button class="btn-refresh" onclick="loadOrders()">
                        <i data-lucide="refresh-cw" class="icon-sm" id="refresh-icon"></i>
                        <span class="refresh-text">Actualizar</span>
                    </button>
                </div>

                <!-- Bulk Actions Bar (created dynamically by dashboard.js) -->

                <!-- Loading State -->
                <div id="orders-loading" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Cargando pedidos...</p>
                </div>

                <!-- Orders List -->
                <div id="orders-container" class="orders-list"></div>

                <!-- Empty State -->
                <div id="empty-state" class="empty-state hidden">
                    <i data-lucide="inbox" class="empty-icon"></i>
                    <h3>No hay pedidos</h3>
                    <p>Los pedidos aparecer√°n aqu√≠ cuando los clientes los env√≠en</p>
                </div>
            </section>

            <!-- Calendar View (Sub-tab of Pedidos) -->
            <section id="calendar-view" class="view">
                <div class="view-header">
                    <h2>üìÖ Calendario de Producci√≥n</h2>
                    <div class="calendar-actions">
                        <div class="calendar-nav">
                            <button class="btn btn-icon" onclick="previousMonth()" title="Mes anterior">
                                ‚óÄ
                            </button>
                            <span id="calendar-month-year" class="calendar-title">Diciembre 2025</span>
                            <button class="btn btn-icon" onclick="nextMonth()" title="Mes siguiente">
                                ‚ñ∂
                            </button>
                            <button class="btn" onclick="goToToday()" style="margin-left: 12px;">
                                Hoy
                            </button>
                        </div>
                        <div class="capacity-info">
                            <span class="capacity-label">Capacidad diaria:</span>
                            <span class="capacity-value" id="daily-capacity-display">2,500 piezas</span>
                        </div>
                    </div>
                </div>

                <!-- Capacity Legend -->
                <div class="calendar-legend">
                    <div class="legend-item">
                        <span class="legend-color" style="background: #dcfce7;"></span>
                        <span>Disponible (&lt;50%)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #fef9c3;"></span>
                        <span>Moderado (50-80%)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #fed7aa;"></span>
                        <span>Alto (80-100%)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #fecaca;"></span>
                        <span>Lleno (100%+)</span>
                    </div>
                </div>

                <!-- Calendar Grid -->
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-day-header">Lun</div>
                        <div class="calendar-day-header">Mar</div>
                        <div class="calendar-day-header">Mi√©</div>
                        <div class="calendar-day-header">Jue</div>
                        <div class="calendar-day-header">Vie</div>
                        <div class="calendar-day-header weekend">S√°b</div>
                        <div class="calendar-day-header weekend">Dom</div>
                    </div>
                    <div id="calendar-grid" class="calendar-grid">
                        <!-- Calendar cells generated by JavaScript -->
                    </div>
                </div>

                <!-- Calendar Stats Summary -->
                <div class="calendar-stats">
                    <div class="stat-box">
                        <span class="stat-icon">üì¶</span>
                        <div class="stat-info">
                            <span class="stat-number" id="cal-total-orders">0</span>
                            <span class="stat-label">Pedidos este mes</span>
                        </div>
                    </div>
                    <div class="stat-box">
                        <span class="stat-icon">üéØ</span>
                        <div class="stat-info">
                            <span class="stat-number" id="cal-total-pieces">0</span>
                            <span class="stat-label">Piezas programadas</span>
                        </div>
                    </div>
                    <div class="stat-box">
                        <span class="stat-icon">‚ö°</span>
                        <div class="stat-info">
                            <span class="stat-number" id="cal-days-full">0</span>
                            <span class="stat-label">D√≠as al l√≠mite</span>
                        </div>
                    </div>
                    <div class="stat-box">
                        <span class="stat-icon">üìà</span>
                        <div class="stat-info">
                            <span class="stat-number" id="cal-avg-capacity">0%</span>
                            <span class="stat-label">Capacidad promedio</span>
                        </div>
                    </div>
                </div>

                <!-- Day Detail Panel (shows when clicking a day) -->
                <div id="day-detail-panel" class="day-detail-panel hidden">
                    <div class="day-detail-header">
                        <h3 id="day-detail-title">Pedidos del d√≠a</h3>
                        <button class="btn-close" onclick="closeDayDetail()">√ó</button>
                    </div>
                    <div class="day-capacity-bar">
                        <div class="capacity-bar-fill" id="day-capacity-fill"></div>
                    </div>
                    <div class="day-capacity-text">
                        <span id="day-pieces-used">0</span> / <span id="day-pieces-total">2,500</span> piezas
                        (<span id="day-capacity-percent">0%</span>)
                    </div>
                    <div id="day-orders-list" class="day-orders-list">
                        <!-- Orders for selected day -->
                    </div>
                </div>
            </section>

            <!-- Order Detail Modal -->
            <div id="order-detail-modal" class="modal hidden">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="modal-title">Detalles del Pedido</h2>
                        <button class="modal-close" onclick="closeOrderDetail()">√ó</button>
                    </div>
                    <div class="modal-body" id="modal-body">
                        <!-- Content loaded dynamically -->
                    </div>
                </div>
                <div class="modal-backdrop" onclick="closeOrderDetail()"></div>
            </div>

            <!-- Client Lookup Modal -->
            <div id="client-lookup-modal" class="modal hidden">
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2>üìû Buscar Pedidos del Cliente</h2>
                        <button class="modal-close" onclick="closeClientLookup()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 20px;">
                            <label for="lookup-phone" style="display: block; margin-bottom: 8px; font-weight: 600;">Tel√©fono:</label>
                            <input type="tel" id="lookup-phone" placeholder="5512345678" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" />
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label for="lookup-email" style="display: block; margin-bottom: 8px; font-weight: 600;">Email (opcional):</label>
                            <input type="email" id="lookup-email" placeholder="cliente@example.com" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" />
                        </div>
                        <button onclick="lookupClientOrders()" class="btn btn-primary" style="width: 100%; padding: 14px; font-size: 16px; font-weight: 600;">
                            üîç Buscar Mis Pedidos
                        </button>

                        <!-- Loading State -->
                        <div id="lookup-loading" class="hidden" style="text-align: center; margin-top: 20px;">
                            <div class="spinner" style="margin: 0 auto;"></div>
                            <p style="margin-top: 12px; color: #6b7280;">Buscando pedidos...</p>
                        </div>

                        <!-- Results Container -->
                        <div id="lookup-results" class="hidden" style="margin-top: 24px;">
                            <div style="border-top: 2px solid #e5e7eb; padding-top: 20px;">
                                <h3 style="margin-bottom: 16px; font-size: 18px; color: #111827;">Pedidos Encontrados</h3>
                                <div id="lookup-orders-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-backdrop" onclick="closeClientLookup()"></div>
            </div>

            <!-- Deposit Confirmation Modal -->
            <div id="deposit-confirmation-modal" class="modal hidden">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2>üíµ Confirmar Anticipo Recibido</h2>
                        <button class="modal-close" onclick="closeDepositModal()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3B82F6;">
                            <div style="margin-bottom: 8px;">
                                <span style="font-weight: 600; color: #6b7280;">Orden:</span>
                                <span id="deposit-order-number" style="font-weight: 700; color: #111827; margin-left: 8px;"></span>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <span style="font-weight: 600; color: #6b7280;">Cliente:</span>
                                <span id="deposit-client-name" style="font-weight: 700; color: #111827; margin-left: 8px;"></span>
                            </div>
                            <div>
                                <span style="font-weight: 600; color: #6b7280;">Total del Pedido:</span>
                                <span id="deposit-total-price" style="font-weight: 700; color: #111827; margin-left: 8px;"></span>
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label for="actual-deposit-amount" style="display: block; margin-bottom: 8px; font-weight: 600; color: #111827;">
                                Monto del Anticipo Recibido (MXN):
                            </label>
                            <div style="position: relative;">
                                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-weight: 600; color: #6b7280;">$</span>
                                <input
                                    type="number"
                                    id="actual-deposit-amount"
                                    placeholder="0.00"
                                    step="0.01"
                                    min="0"
                                    style="width: 100%; padding: 12px 12px 12px 28px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 18px; font-weight: 600;"
                                />
                            </div>
                            <p style="margin-top: 8px; font-size: 13px; color: #6b7280;">
                                Ingresa el monto exacto del anticipo que recibiste del cliente
                            </p>
                        </div>

                        <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
                            <p style="margin: 0; font-size: 13px; color: #92400e;">
                                <strong>Nota:</strong> Se generar√° un recibo PDF con este monto y se enviar√° autom√°ticamente al cliente por correo electr√≥nico.
                            </p>
                        </div>

                        <div style="display: flex; gap: 12px;">
                            <button onclick="closeDepositModal()" class="btn btn-secondary" style="flex: 1; padding: 12px;">
                                Cancelar
                            </button>
                            <button onclick="confirmApproveWithDeposit()" class="btn btn-success" style="flex: 1; padding: 12px;">
                                ‚úÖ Aprobar y Generar Recibo
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-backdrop" onclick="closeDepositModal()"></div>
            </div>

            <!-- Create Order Modal -->
            <div id="create-order-modal" class="modal hidden">
                <div class="modal-content modal-large" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h2><i data-lucide="plus-circle" class="icon-sm" style="display: inline; vertical-align: middle;"></i> Crear Nuevo Pedido</h2>
                        <button class="modal-close" onclick="closeCreateOrderModal()">√ó</button>
                    </div>
                    <div class="modal-body" style="padding: 24px;">
                        <!-- Step indicator -->
                        <div class="create-order-steps" style="display: flex; justify-content: center; gap: 8px; margin-bottom: 24px;">
                            <div class="step active" data-step="1">
                                <span class="step-number">1</span>
                                <span class="step-label">Cliente</span>
                            </div>
                            <div class="step-connector"></div>
                            <div class="step" data-step="2">
                                <span class="step-number">2</span>
                                <span class="step-label">Productos</span>
                            </div>
                        </div>

                        <!-- Step 1: Client Info -->
                        <div id="create-order-step-1" class="create-order-step">
                            <h3 style="margin-bottom: 16px; color: #374151;">Informaci√≥n del Cliente</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div class="form-group">
                                    <label for="new-order-client-name">Nombre del Cliente *</label>
                                    <input type="text" id="new-order-client-name" placeholder="Ej: Mar√≠a Gonz√°lez" required>
                                </div>
                                <div class="form-group">
                                    <label for="new-order-client-phone">Tel√©fono *</label>
                                    <input type="tel" id="new-order-client-phone" placeholder="Ej: 5512345678" required>
                                </div>
                                <div class="form-group">
                                    <label for="new-order-client-email">Email</label>
                                    <input type="email" id="new-order-client-email" placeholder="Ej: maria@email.com">
                                </div>
                                <div class="form-group">
                                    <label for="new-order-client-city">Ciudad</label>
                                    <input type="text" id="new-order-client-city" placeholder="Ej: Ciudad de M√©xico">
                                </div>
                            </div>
                            <div class="form-group" style="margin-top: 16px;">
                                <label for="new-order-client-address">Direcci√≥n de Env√≠o</label>
                                <textarea id="new-order-client-address" rows="2" placeholder="Calle, n√∫mero, colonia, CP..."></textarea>
                            </div>
                        </div>

                        <!-- Step 2: Products -->
                        <div id="create-order-step-2" class="create-order-step hidden">
                            <h3 style="margin-bottom: 16px; color: #374151;">Seleccionar Productos</h3>
                            <div id="create-order-products-list" style="display: grid; gap: 12px; max-height: 350px; overflow-y: auto; padding-right: 8px;">
                                <!-- Products loaded dynamically -->
                            </div>
                            <div class="order-summary-bar" style="margin-top: 16px; padding: 16px; background: #f0fdf4; border-radius: 8px; border: 1px solid #bbf7d0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 600; color: #166534;">Total del Pedido:</span>
                                    <span id="create-order-total" style="font-size: 24px; font-weight: 700; color: #166534;">$0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div style="display: flex; justify-content: space-between; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                            <button id="create-order-prev-btn" class="btn btn-secondary" onclick="createOrderPrevStep()" style="display: none;">
                                ‚Üê Anterior
                            </button>
                            <div style="margin-left: auto; display: flex; gap: 12px;">
                                <button class="btn btn-secondary" onclick="closeCreateOrderModal()">Cancelar</button>
                                <button id="create-order-next-btn" class="btn btn-primary" onclick="createOrderNextStep()">
                                    Siguiente ‚Üí
                                </button>
                                <button id="create-order-submit-btn" class="btn btn-success" onclick="submitNewOrder()" style="display: none;">
                                    ‚úì Crear Pedido
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-backdrop" onclick="closeCreateOrderModal()"></div>
            </div>

            <!-- Reference Sheet Generator Modal (AXKAN ORDEN DE COMPRA) -->
            <div id="reference-sheet-modal" class="modal hidden">
                <div class="modal-content" style="max-width: 950px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #333 0%, #1a1a1a 100%); padding: 15px 20px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <!-- AXKAN colorful logo -->
                            <div style="display: flex;">
                                <span style="font-size: 24px; font-weight: 800; color: #E91E63;">A</span>
                                <span style="font-size: 24px; font-weight: 800; color: #7CB342;">X</span>
                                <span style="font-size: 24px; font-weight: 800; color: #FF9800;">K</span>
                                <span style="font-size: 24px; font-weight: 800; color: #00BCD4;">A</span>
                                <span style="font-size: 24px; font-weight: 800; color: #F44336;">N</span>
                            </div>
                            <h2 style="margin: 0; color: white; font-size: 16px;">Generador de Hoja de Referencia</h2>
                        </div>
                        <button class="modal-close" onclick="closeRefSheetModal()" style="color: white;">√ó</button>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        <!-- Step 1: Order Info -->
                        <div id="ref-sheet-step-1">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div class="form-group">
                                    <label style="font-weight: 600; color: #333;">Nombre del Pedido</label>
                                    <input type="text" id="ref-sheet-order-name" placeholder="Ej: CD ALTAMIRANO"
                                           style="padding: 12px; border: 2px solid #E91E63; border-radius: 8px; font-size: 14px;">
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 600; color: #333;">Instrucciones (opcional)</label>
                                    <input type="text" id="ref-sheet-instructions" placeholder="Ej: SON 50 C/U"
                                           style="padding: 12px; border: 2px solid #00BCD4; border-radius: 8px; font-size: 14px;">
                                </div>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="font-weight: 600; color: #333; display: block; margin-bottom: 10px;">N√∫mero de Dise√±os</label>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button onclick="selectNumDesigns(3)" class="num-designs-btn" data-num="3"
                                            style="padding: 15px 25px; font-size: 18px; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; background: #E91E63; color: white;">3</button>
                                    <button onclick="selectNumDesigns(5)" class="num-designs-btn" data-num="5"
                                            style="padding: 15px 25px; font-size: 18px; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; background: #7CB342; color: white;">5</button>
                                    <button onclick="selectNumDesigns(6)" class="num-designs-btn" data-num="6"
                                            style="padding: 15px 25px; font-size: 18px; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; background: #FF9800; color: white;">6</button>
                                    <button onclick="selectNumDesigns(9)" class="num-designs-btn" data-num="9"
                                            style="padding: 15px 25px; font-size: 18px; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; background: #00BCD4; color: white;">9</button>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-left: 10px;">
                                        <span style="color: #666;">Otro:</span>
                                        <input type="number" id="ref-sheet-custom-num" min="1" max="20" placeholder="..."
                                               onchange="selectNumDesigns(this.value)"
                                               style="width: 60px; padding: 10px; border: 2px solid #ccc; border-radius: 8px; font-size: 16px;">
                                    </div>
                                </div>
                                <p id="ref-sheet-selected-num" style="margin-top: 10px; color: #E91E63; font-weight: 600;">Seleccionado: -</p>
                            </div>

                            <div style="display: flex; justify-content: flex-end; gap: 12px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                                <button class="btn btn-secondary" onclick="closeRefSheetModal()">Cancelar</button>
                                <button class="btn btn-primary" onclick="goToRefSheetStep2()" style="background: #E91E63;">
                                    Continuar ‚Üí
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Design Slots -->
                        <div id="ref-sheet-step-2" class="hidden">
                            <p style="text-align: center; color: #666; margin-bottom: 15px;">
                                Haz clic en un slot y pega una imagen (Ctrl+V / Cmd+V) o usa "Examinar"
                            </p>

                            <div id="ref-sheet-designs-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-height: 55vh; overflow-y: auto; padding: 10px;">
                                <!-- Design slots generated dynamically -->
                            </div>

                            <div style="display: flex; justify-content: space-between; gap: 12px; padding-top: 16px; border-top: 1px solid #e5e7eb; margin-top: 16px;">
                                <button class="btn btn-secondary" onclick="goToRefSheetStep1()">‚Üê Anterior</button>
                                <div style="display: flex; gap: 12px;">
                                    <button class="btn btn-secondary" onclick="closeRefSheetModal()">Cancelar</button>
                                    <button class="btn btn-success" onclick="generateRefSheetPDF()" id="ref-sheet-generate-btn"
                                            style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                        üìÑ Generar PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-backdrop" onclick="closeRefSheetModal()"></div>
            </div>

            <!-- Discounts View (Sub-tab of Pedidos) -->
            <section id="discounts-view" class="view">
                <div class="view-header">
                    <h2>üè∑Ô∏è Clientes Especiales y Descuentos</h2>
                    <button class="btn btn-primary" onclick="openAddSpecialClientModal()">
                        + Agregar Cliente Especial
                    </button>
                </div>

                <!-- Search Bar -->
                <div class="special-clients-search">
                    <div class="search-input-wrapper">
                        <span class="search-icon">üîç</span>
                        <input type="text"
                               id="special-clients-search"
                               placeholder="Buscar por nombre, email o empresa..."
                               oninput="filterSpecialClients(this.value)">
                        <button class="clear-search-btn hidden" id="clear-special-search" onclick="clearSpecialClientsSearch()">√ó</button>
                    </div>
                </div>

                <!-- Special Clients List -->
                <div class="special-clients-container">
                    <div id="special-clients-loading" class="loading hidden">
                        <div class="spinner"></div>
                        <p>Cargando clientes especiales...</p>
                    </div>

                    <div id="special-clients-list" class="special-clients-grid">
                        <!-- Generated by JavaScript -->
                    </div>

                    <div id="special-clients-empty" class="empty-state hidden">
                        <span class="empty-icon">üè∑Ô∏è</span>
                        <h3>No hay clientes especiales</h3>
                        <p>Agrega clientes con precios personalizados usando el bot√≥n de arriba</p>
                    </div>
                </div>
            </section>

            <!-- Add/Edit Special Client Modal -->
            <div id="special-client-modal" class="modal hidden">
                <div class="modal-content modal-large">
                    <div class="modal-header">
                        <h3 id="special-client-modal-title">Agregar Cliente Especial</h3>
                        <button class="btn-close" onclick="closeSpecialClientModal()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="edit-special-client-id">

                        <div class="form-section">
                            <h4>Informaci√≥n del Cliente</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="special-client-name">Nombre *</label>
                                    <input type="text" id="special-client-name" placeholder="Nombre del cliente">
                                </div>
                                <div class="form-group">
                                    <label for="special-client-email">Email *</label>
                                    <input type="email" id="special-client-email" placeholder="correo@ejemplo.com">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="special-client-phone">Tel√©fono *</label>
                                    <input type="tel" id="special-client-phone" placeholder="5512345678" maxlength="10">
                                </div>
                                <div class="form-group">
                                    <label for="special-client-company">Empresa (opcional)</label>
                                    <input type="text" id="special-client-company" placeholder="Nombre de empresa">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>Precios Personalizados</h4>
                            <p class="help-text">Deja en blanco para usar precio normal</p>
                            <div id="custom-prices-container" class="custom-prices-grid">
                                <!-- Product price inputs generated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeSpecialClientModal()">Cancelar</button>
                        <button class="btn btn-primary" onclick="saveSpecialClient()">Guardar Cliente</button>
                    </div>
                </div>
                <div class="modal-backdrop" onclick="closeSpecialClientModal()"></div>
            </div>

            <!-- Special Client Detail Modal (with TOTP code) -->
            <div id="special-client-detail-modal" class="modal hidden">
                <div class="modal-content modal-large">
                    <div class="modal-header">
                        <h3 id="detail-client-name">Cliente Especial</h3>
                        <button class="btn-close" onclick="closeSpecialClientDetailModal()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="client-info-section">
                            <div class="client-info-row">
                                <span class="info-label">Email:</span>
                                <span id="detail-client-email">-</span>
                            </div>
                            <div class="client-info-row">
                                <span class="info-label">Tel√©fono:</span>
                                <span id="detail-client-phone">-</span>
                            </div>
                            <div class="client-info-row">
                                <span class="info-label">Empresa:</span>
                                <span id="detail-client-company">-</span>
                            </div>
                        </div>

                        <!-- TOTP Code Generator -->
                        <div class="totp-section">
                            <h4>C√≥digo Promocional</h4>
                            <p class="help-text">Este c√≥digo rota cada 30 segundos (como Google Authenticator)</p>
                            <div class="totp-display">
                                <span id="totp-code" class="totp-code">------</span>
                                <div class="totp-timer">
                                    <div id="totp-timer-bar" class="totp-timer-bar"></div>
                                </div>
                                <span id="totp-countdown" class="totp-countdown">30s</span>
                            </div>
                            <button class="btn btn-secondary" onclick="copyTotpCode()">
                                üìã Copiar C√≥digo
                            </button>
                        </div>

                        <!-- Custom Prices Table -->
                        <div class="prices-section">
                            <h4>Precios por Producto</h4>
                            <table class="prices-table">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th>Precio Normal</th>
                                        <th>Precio Especial</th>
                                        <th>Descuento</th>
                                        <th>Editar</th>
                                    </tr>
                                </thead>
                                <tbody id="detail-prices-table">
                                    <!-- Generated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-danger" onclick="deleteSpecialClient()">Eliminar Cliente</button>
                        <button class="btn btn-secondary" onclick="editSpecialClientFromDetail()">Editar</button>
                        <button class="btn btn-primary" onclick="closeSpecialClientDetailModal()">Cerrar</button>
                    </div>
                </div>
                <div class="modal-backdrop" onclick="closeSpecialClientDetailModal()"></div>
            </div>

            <!-- Analytics View -->
            <section id="analytics-view" class="view">
                <div class="view-header">
                    <h2>üìä Anal√≠ticas</h2>
                    <div class="analytics-actions">
                        <button class="btn" onclick="exportAnalyticsCSV()">
                            üì• Exportar CSV
                        </button>
                        <button class="btn btn-primary" onclick="loadAnalyticsData()">
                            üîÑ Actualizar
                        </button>
                    </div>
                </div>

                <!-- Date Range Filters -->
                <div class="analytics-filters">
                    <div class="quick-ranges">
                        <button class="quick-range-btn" data-days="7" onclick="setQuickDateRange(7)">7 d√≠as</button>
                        <button class="quick-range-btn active" data-days="30" onclick="setQuickDateRange(30)">30 d√≠as</button>
                        <button class="quick-range-btn" data-days="90" onclick="setQuickDateRange(90)">90 d√≠as</button>
                        <button class="quick-range-btn" data-days="365" onclick="setQuickDateRange(365)">1 a√±o</button>
                    </div>
                    <div class="date-range-inputs">
                        <div class="date-input-group">
                            <label for="analytics-start-date">Desde</label>
                            <input type="date" id="analytics-start-date" onchange="handleDateRangeChange()">
                        </div>
                        <div class="date-input-group">
                            <label for="analytics-end-date">Hasta</label>
                            <input type="date" id="analytics-end-date" onchange="handleDateRangeChange()">
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="analytics-loading" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Cargando anal√≠ticas...</p>
                </div>

                <!-- Analytics Content -->
                <div id="analytics-content" class="analytics-content">
                    <!-- Summary Cards -->
                    <div id="analytics-summary-cards" class="analytics-summary-cards">
                        <!-- Dynamic KPI cards -->
                    </div>

                    <!-- Charts Row 1: Revenue over time -->
                    <div class="analytics-section">
                        <div class="section-header">
                            <h3>üìà Ingresos y Ganancia</h3>
                        </div>
                        <div class="chart-container large">
                            <canvas id="revenue-chart"></canvas>
                        </div>
                    </div>

                    <!-- Charts Row 2: Pie charts side by side -->
                    <div class="analytics-row">
                        <div class="analytics-section half">
                            <div class="section-header">
                                <h3>üõçÔ∏è Ventas por Categor√≠a</h3>
                            </div>
                            <div class="chart-container medium">
                                <canvas id="products-pie-chart"></canvas>
                            </div>
                        </div>
                        <div class="analytics-section half">
                            <div class="section-header">
                                <h3>üìã Estado de Pedidos</h3>
                            </div>
                            <div class="chart-container medium">
                                <canvas id="status-pie-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row 3: Top products and clients -->
                    <div class="analytics-row">
                        <div class="analytics-section half">
                            <div class="section-header">
                                <h3>üèÜ Productos M√°s Vendidos</h3>
                            </div>
                            <div id="top-products-list" class="ranking-list">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                        <div class="analytics-section half">
                            <div class="section-header">
                                <h3>üë• Mejores Clientes</h3>
                            </div>
                            <div id="top-clients-list" class="ranking-list">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row 4: Revenue by city -->
                    <div class="analytics-section">
                        <div class="section-header">
                            <h3>üó∫Ô∏è Ingresos por Ciudad</h3>
                        </div>
                        <div class="chart-container medium">
                            <canvas id="city-chart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Products / Inventory View -->
            <section id="products-view" class="view">
                <div class="view-header">
                    <h2>üì¶ Inventario de Materiales</h2>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="showQuickReceiveModal()">
                            ‚ö° Quick Receive
                        </button>
                        <button class="btn btn-primary" onclick="showInvoiceUploadModal()">
                            üì∏ Upload Invoice
                        </button>
                        <button class="btn" onclick="showPrintLabelsModal()">
                            üè∑Ô∏è Print Labels
                        </button>
                        <button class="btn" onclick="printSmartBarcodes()" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; font-weight: 700;">
                            üè∑Ô∏èüìä Print Smart Barcodes
                        </button>
                        <button class="btn btn-primary" onclick="showAddMaterialModal()">
                            ‚ûï Add Material
                        </button>
                    </div>
                </div>

                <!-- Alert Summary -->
                <div id="alert-summary" class="alert-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <!-- Dynamic content -->
                </div>

                <!-- Loading State -->
                <div id="inventory-loading" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Cargando inventario...</p>
                </div>

                <!-- Materials Grid -->
                <div id="materials-container" class="materials-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                    <!-- Dynamic content -->
                </div>

                <!-- Empty State -->
                <div id="inventory-empty-state" class="empty-state hidden">
                    <span class="empty-icon">üì¶</span>
                    <h3>No hay materiales</h3>
                    <p>Agrega tu primer material para comenzar a gestionar el inventario</p>
                </div>
            </section>

            <!-- Prices View -->
            <section id="prices-view" class="view">
                <div class="view-header">
                    <h2>üí∞ Precios y M√°rgenes</h2>
                    <div style="display: flex; gap: 12px;">
                        <select id="price-period-select" onchange="loadPriceDashboard(this.value)" style="padding: 10px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-weight: 600;">
                            <option value="7">√öltimos 7 d√≠as</option>
                            <option value="30" selected>√öltimos 30 d√≠as</option>
                            <option value="90">√öltimos 90 d√≠as</option>
                            <option value="180">√öltimos 6 meses</option>
                        </select>
                        <button class="btn btn-primary" onclick="refreshPriceTrends()">
                            üîÑ Actualizar
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="prices-loading" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Cargando datos de precios...</p>
                </div>

                <!-- Summary Cards -->
                <div id="price-summary-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 24px;">
                    <!-- Dynamic content -->
                </div>

                <!-- Alerts Section -->
                <div id="price-alerts" style="margin-bottom: 24px;">
                    <!-- Dynamic content -->
                </div>

                <!-- Tabs for different views -->
                <div class="price-tabs" style="margin-bottom: 20px;">
                    <button class="price-tab-btn active" data-tab="overview" onclick="switchPriceTab('overview')">
                        üìä Resumen
                    </button>
                    <button class="price-tab-btn" data-tab="bom" onclick="switchPriceTab('bom')">
                        üîß Componentes (BOM)
                    </button>
                    <button class="price-tab-btn" data-tab="receipts" onclick="switchPriceTab('receipts')">
                        üßæ Recibos de Compra
                    </button>
                </div>

                <!-- Overview Tab -->
                <div id="price-tab-overview" class="price-tab-content active">
                    <div class="card">
                        <h3 style="margin: 0 0 16px 0;">üèÜ Productos</h3>
                        <div id="top-products-table">
                            <!-- Table will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- BOM Tab -->
                <div id="price-tab-bom" class="price-tab-content">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                        <!-- Raw Materials Section -->
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 style="margin: 0;">üì¶ Materiales Disponibles</h3>
                                <button class="btn btn-primary" onclick="openAddMaterialModal()">+ Agregar Material</button>
                            </div>
                            <div id="raw-materials-list">
                                <!-- Materials will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Receipts Tab -->
                <div id="price-tab-receipts" class="price-tab-content">
                    <div class="card" style="margin-bottom: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div>
                                <h3 style="margin: 0 0 8px 0;">üßæ Recibos de Proveedores</h3>
                                <p style="margin: 0; color: #6b7280; font-size: 14px;">
                                    Sube recibos de compra y Claude los analizara automaticamente
                                </p>
                            </div>
                            <button class="btn btn-primary" onclick="openReceiptUploadModal()" style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">üì§</span>
                                Subir Recibo
                            </button>
                        </div>

                        <!-- Recent Receipts -->
                        <div id="receipts-list-container">
                            <div id="receipts-loading" class="loading hidden">
                                <div class="spinner"></div>
                                <p>Cargando recibos...</p>
                            </div>
                            <div id="receipts-list">
                                <!-- Receipts will be rendered here -->
                            </div>
                            <div id="receipts-empty" class="hidden" style="text-align: center; padding: 40px; color: #6b7280;">
                                <div style="font-size: 48px; margin-bottom: 16px;">üßæ</div>
                                <p style="margin: 0;">No hay recibos registrados aun</p>
                                <p style="margin: 8px 0 0 0; font-size: 14px;">Sube tu primer recibo para comenzar</p>
                            </div>
                        </div>
                    </div>

                    <!-- Suppliers Summary -->
                    <div class="card">
                        <h3 style="margin: 0 0 16px 0;">üè™ Proveedores</h3>
                        <div id="suppliers-list">
                            <!-- Suppliers will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="prices-empty-state" class="empty-state hidden">
                    <span class="empty-icon">üí∞</span>
                    <h3>No hay datos de precios</h3>
                    <p>Los datos aparecer√°n cuando haya productos con historial de precios</p>
                </div>
            </section>

            <!-- Comisiones View -->
            <section id="comisiones-view" class="view">
                <div class="view-header">
                    <h2>üí∞ Resumen de Comisiones</h2>
                    <button class="btn btn-primary" onclick="loadComisionesView()">
                        üîÑ Actualizar
                    </button>
                </div>

                <div id="comisiones-loading" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Cargando datos de comisiones...</p>
                </div>

                <!-- Summary Cards -->
                <div id="comisiones-summary-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 24px;">
                </div>

                <!-- Salespeople Table -->
                <div id="comisiones-table-container" style="margin-bottom: 24px;">
                </div>

                <!-- Monthly Breakdown -->
                <div id="comisiones-monthly-container">
                </div>

                <!-- Empty State -->
                <div id="comisiones-empty" class="empty-state hidden">
                    <span class="empty-icon">üìä</span>
                    <h3>No hay datos de comisiones disponibles</h3>
                    <p>Las comisiones se calculan autom√°ticamente cuando los pedidos tienen un vendedor asignado.</p>
                </div>
            </section>

            <!-- Shipping/Env√≠os View -->
            <section id="shipping-view" class="view">
                <div class="view-header">
                    <h2>üì¶ Base de Datos de Env√≠os</h2>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-select" id="select-mode-btn" onclick="toggleSelectMode()">
                            ‚òë Seleccionar
                        </button>
                        <button class="btn btn-primary" onclick="showAddClientModal()">
                            ‚ûï Agregar Cliente
                        </button>
                        <button class="btn" onclick="triggerImportCSV()">
                            üì§ Importar CSV
                        </button>
                        <button class="btn" onclick="exportClientsCSV()">
                            üì• Exportar CSV
                        </button>
                        <button class="btn" id="autocomplete-btn" onclick="autoCompleteAddresses()" title="Completar datos faltantes usando codigos postales">
                            üîÑ Auto-completar
                        </button>
                        <input type="file" id="csv-import-input" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">
                    </div>
                </div>

                <!-- Bulk Action Bar (hidden until selection) -->
                <div id="bulk-action-bar" class="bulk-action-bar hidden">
                    <div class="bulk-action-left">
                        <label class="bulk-select-all">
                            <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll()" />
                            Todos
                        </label>
                        <span class="bulk-count" id="bulk-selected-count">0 clientes</span>
                    </div>
                    <div class="bulk-action-right">
                        <button class="bulk-btn" onclick="bulkGenerateLabels()" title="Generar etiquetas de envio">
                            üè∑Ô∏è Etiquetas
                        </button>
                        <button class="bulk-btn" onclick="bulkExportCSV()" title="Exportar seleccionados a CSV">
                            üì• Exportar
                        </button>
                        <button class="bulk-btn danger" onclick="bulkDelete()" title="Eliminar seleccionados">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>

                <!-- Search Bar + Sort Toggle -->
                <div class="shipping-toolbar">
                    <div class="shipping-search-container">
                        <span class="search-icon">üîç</span>
                        <input type="text" id="shipping-search-input" class="shipping-search-input"
                            placeholder="Buscar por nombre, tel√©fono, ciudad, estado, CP..."
                            oninput="handleShippingSearch(this.value)" />
                        <button class="search-clear" id="shipping-search-clear" onclick="clearShippingSearch()" style="display: none;">‚úï</button>
                    </div>

                    <div class="shipping-sort-toggle">
                        <button class="sort-btn active" id="sort-recent-btn" onclick="setShippingSort('recent')">Recientes</button>
                        <button class="sort-btn" id="sort-alpha-btn" onclick="setShippingSort('alpha')">A-Z</button>
                    </div>
                </div>

                <!-- Quick Filter Tabs -->
                <div class="shipping-quick-filters" id="shipping-quick-filters">
                    <button class="quick-filter-tab active" data-filter="all" onclick="setQuickFilter('all')">
                        Todos <span class="quick-filter-count" id="filter-count-all">0</span>
                    </button>
                    <button class="quick-filter-tab" data-filter="withAddress" onclick="setQuickFilter('withAddress')">
                        Con Direcci√≥n <span class="quick-filter-count" id="filter-count-with">0</span>
                    </button>
                    <button class="quick-filter-tab" data-filter="withoutAddress" onclick="setQuickFilter('withoutAddress')">
                        Sin Direcci√≥n <span class="quick-filter-count" id="filter-count-without">0</span>
                    </button>
                    <button class="quick-filter-tab" data-filter="recent" onclick="setQuickFilter('recent')">
                        Recientes <span class="quick-filter-count" id="filter-count-recent">0</span>
                    </button>
                </div>

                <!-- Location Filter Chips -->
                <div class="shipping-location-filters">
                    <div class="filter-chips" id="filter-chips">
                        <button class="filter-chip" onclick="toggleFilterDropdown('city')">
                            <span>Ciudad</span>
                            <span class="chip-arrow">‚ñº</span>
                        </button>
                        <button class="filter-chip" onclick="toggleFilterDropdown('state')">
                            <span>Estado</span>
                            <span class="chip-arrow">‚ñº</span>
                        </button>
                    </div>
                    <div class="active-filters" id="active-filters"></div>
                </div>

                <!-- Filter Dropdown -->
                <div id="filter-dropdown" class="filter-dropdown hidden">
                    <div class="filter-dropdown-content" id="filter-dropdown-content"></div>
                </div>

                <!-- Loading State -->
                <div id="shipping-loading" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Cargando clientes...</p>
                </div>

                <!-- Address Cards Grid -->
                <div id="shipping-cards-container" class="address-cards-grid"></div>

                <!-- Empty State -->
                <div id="shipping-empty-state" class="empty-state hidden">
                    <span class="empty-icon">üì¶</span>
                    <h3>No hay clientes</h3>
                    <p>Los clientes aparecer√°n aqu√≠ cuando env√≠en pedidos</p>
                </div>

                <!-- Pagination -->
                <div class="shipping-pagination" id="shipping-pagination">
                    <button class="pagination-btn" onclick="goToShippingPage('prev')" id="prev-page-btn">‚Üê Anterior</button>
                    <span class="pagination-info" id="pagination-info">P√°gina 1 de 1</span>
                    <button class="pagination-btn" onclick="goToShippingPage('next')" id="next-page-btn">Siguiente ‚Üí</button>
                </div>

                <!-- Client Edit Modal -->
                <div id="client-modal" class="modal hidden">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3 id="client-modal-title">Editar Cliente</h3>
                            <button class="modal-close" onclick="closeClientModal()">&times;</button>
                        </div>
                        <form id="client-form" onsubmit="saveClient(event)">
                            <input type="hidden" id="client_id">
                            <div class="form-group">
                                <label for="client_name">Nombre *</label>
                                <input type="text" id="client_name" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="client_phone">Tel√©fono</label>
                                    <input type="tel" id="client_phone">
                                </div>
                                <div class="form-group">
                                    <label for="client_email">Email</label>
                                    <input type="email" id="client_email">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="client_street">Calle</label>
                                <input type="text" id="client_street">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="client_street_number">N√∫mero</label>
                                    <input type="text" id="client_street_number">
                                </div>
                                <div class="form-group">
                                    <label for="client_colonia">Colonia</label>
                                    <input type="text" id="client_colonia">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="client_city">Ciudad</label>
                                    <input type="text" id="client_city">
                                </div>
                                <div class="form-group">
                                    <label for="client_state">Estado</label>
                                    <input type="text" id="client_state">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="client_postal_code">C√≥digo Postal</label>
                                    <input type="text" id="client_postal_code">
                                </div>
                                <div class="form-group">
                                    <label for="client_reference_notes">Referencias</label>
                                    <input type="text" id="client_reference_notes" maxlength="35">
                                </div>
                            </div>
                            <div class="modal-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeClientModal()">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Gu√≠as View -->
            <section id="guias-view" class="view">
                <div class="view-header">
                    <h2>üè∑Ô∏è Gesti√≥n de Gu√≠as</h2>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn" onclick="refreshGuias()">
                            üîÑ Actualizar
                        </button>
                        <button class="btn" onclick="exportGuiasCSV()">
                            üì• Exportar CSV
                        </button>
                    </div>
                </div>

                <!-- Guias Filters Bar -->
                <div class="shipping-filters-bar">
                    <div class="shipping-search-container">
                        <span class="search-icon">üîç</span>
                        <input type="text" id="guias-search-input" class="shipping-search-input"
                            placeholder="Buscar por tracking, orden, cliente..."
                            oninput="handleGuiasSearch(this.value)" />
                        <button class="search-clear" id="guias-search-clear" onclick="clearGuiasSearch()" style="display: none;">‚úï</button>
                    </div>

                    <!-- Status Filter Chips -->
                    <div class="filter-chips">
                        <button class="filter-chip guias-status-filter active" data-status="all" onclick="filterGuiasByStatus('all')">
                            Todas
                        </button>
                        <button class="filter-chip guias-status-filter" data-status="label_generated" onclick="filterGuiasByStatus('label_generated')">
                            üìÑ Generadas
                        </button>
                        <button class="filter-chip guias-status-filter" data-status="shipped" onclick="filterGuiasByStatus('shipped')">
                            üöö Enviadas
                        </button>
                        <button class="filter-chip guias-status-filter" data-status="delivered" onclick="filterGuiasByStatus('delivered')">
                            ‚úÖ Entregadas
                        </button>
                    </div>
                </div>

                <!-- Guias Stats -->
                <div class="shipping-stats" id="guias-stats">
                    <div class="stat-item">
                        <span class="stat-number" id="guias-total">0</span>
                        <span class="stat-label">Total Gu√≠as</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="guias-generated">0</span>
                        <span class="stat-label">Generadas</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="guias-shipped">0</span>
                        <span class="stat-label">Enviadas</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="guias-delivered">0</span>
                        <span class="stat-label">Entregadas</span>
                    </div>
                </div>

                <!-- Guias Table -->
                <div class="shipping-table-container">
                    <table class="shipping-table" id="guias-table">
                        <thead>
                            <tr>
                                <th>Orden</th>
                                <th>Cliente</th>
                                <th>Tracking</th>
                                <th>Paqueter√≠a</th>
                                <th>D√≠as</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="guias-table-body">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">
                                    Cargando gu√≠as...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="guias-empty-state" class="empty-state hidden">
                    <span class="empty-icon">üè∑Ô∏è</span>
                    <h3>No hay gu√≠as</h3>
                    <p>Las gu√≠as aparecer√°n aqu√≠ cuando los clientes generen env√≠os</p>
                </div>

                <!-- Guias Pagination -->
                <div class="shipping-pagination" id="guias-pagination">
                    <button class="pagination-btn" onclick="goToGuiasPage('prev')" id="guias-prev-page-btn">‚Üê Anterior</button>
                    <span class="pagination-info" id="guias-pagination-info">P√°gina 1 de 1</span>
                    <button class="pagination-btn" onclick="goToGuiasPage('next')" id="guias-next-page-btn">Siguiente ‚Üí</button>
                </div>
            </section>

            <!-- Pickups View -->
            <section id="pickups-view" class="view">
                <div class="view-header">
                    <h2>üöö Recolecciones Programadas</h2>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button onclick="changePickupDate(-1)" class="btn">‚óÄ</button>
                            <input type="date" id="pickups-date-input" onchange="loadPickupsForDate(this.value)" style="padding: 10px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-weight: 600;">
                            <button onclick="changePickupDate(1)" class="btn">‚ñ∂</button>
                        </div>
                        <button onclick="loadPickupsForDate(document.getElementById('pickups-date-input').value)" class="btn">
                            üîÑ Actualizar
                        </button>
                        <button onclick="triggerPendingPickups()" class="btn btn-success">
                            üì¶ Solicitar Pendientes
                        </button>
                    </div>
                </div>

                <!-- Stats summary -->
                <div id="pickups-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                    <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 32px; font-weight: 700; color: #667eea;" id="pickups-total-count">0</div>
                        <div style="font-size: 14px; color: #6b7280;">Total Pickups</div>
                    </div>
                    <div style="background: #fef3c7; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 32px; font-weight: 700; color: #f59e0b;" id="pickups-pending-count">0</div>
                        <div style="font-size: 14px; color: #6b7280;">Pendientes</div>
                    </div>
                    <div style="background: #d1fae5; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 32px; font-weight: 700; color: #059669;" id="pickups-requested-count">0</div>
                        <div style="font-size: 14px; color: #6b7280;">Solicitados</div>
                    </div>
                    <div style="background: #ede9fe; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 32px; font-weight: 700; color: #7c3aed;" id="pickups-shipments-count">0</div>
                        <div style="font-size: 14px; color: #6b7280;">Env√≠os</div>
                    </div>
                </div>

                <!-- Quick Pickup Buttons by Carrier -->
                <div style="background: white; padding: 24px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                    <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #374151;">
                        üöÄ Solicitar Recolecci√≥n por Paqueter√≠a
                    </h3>
                    <p style="margin: 0 0 20px 0; font-size: 14px; color: #6b7280;">
                        Haz clic en una paqueter√≠a para programar una recolecci√≥n. Se abrir√° un formulario para configurar fecha y horario.
                    </p>
                    <div id="carrier-pickup-buttons" style="display: flex; flex-wrap: wrap; gap: 12px;">
                        <button onclick="openPickupModal('Estafeta')" class="carrier-pickup-btn" style="display: flex; align-items: center; gap: 10px; padding: 14px 24px; background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 12px; font-size: 15px; font-weight: 700; color: #92400e; cursor: pointer; transition: all 0.2s;">
                            <span style="font-size: 24px;">üì¶</span>
                            <span>Estafeta</span>
                        </button>
                        <button onclick="openPickupModal('Paquetexpress')" class="carrier-pickup-btn" style="display: flex; align-items: center; gap: 10px; padding: 14px 24px; background: linear-gradient(135deg, #d1fae5, #a7f3d0); border: 2px solid #10b981; border-radius: 12px; font-size: 15px; font-weight: 700; color: #065f46; cursor: pointer; transition: all 0.2s;">
                            <span style="font-size: 24px;">üöõ</span>
                            <span>Paquetexpress</span>
                        </button>
                        <button onclick="openPickupModal('FedEx')" class="carrier-pickup-btn" style="display: flex; align-items: center; gap: 10px; padding: 14px 24px; background: linear-gradient(135deg, #dbeafe, #bfdbfe); border: 2px solid #3b82f6; border-radius: 12px; font-size: 15px; font-weight: 700; color: #1e40af; cursor: pointer; transition: all 0.2s;">
                            <span style="font-size: 24px;">‚úàÔ∏è</span>
                            <span>FedEx</span>
                        </button>
                        <button onclick="openPickupModal('DHL')" class="carrier-pickup-btn" style="display: flex; align-items: center; gap: 10px; padding: 14px 24px; background: linear-gradient(135deg, #fee2e2, #fecaca); border: 2px solid #ef4444; border-radius: 12px; font-size: 15px; font-weight: 700; color: #991b1b; cursor: pointer; transition: all 0.2s;">
                            <span style="font-size: 24px;">üü°</span>
                            <span>DHL</span>
                        </button>
                        <button onclick="openPickupModal('UPS')" class="carrier-pickup-btn" style="display: flex; align-items: center; gap: 10px; padding: 14px 24px; background: linear-gradient(135deg, #fef3c7, #fcd34d); border: 2px solid #d97706; border-radius: 12px; font-size: 15px; font-weight: 700; color: #92400e; cursor: pointer; transition: all 0.2s;">
                            <span style="font-size: 24px;">üì¨</span>
                            <span>UPS</span>
                        </button>
                        <button onclick="openPickupModal('Redpack')" class="carrier-pickup-btn" style="display: flex; align-items: center; gap: 10px; padding: 14px 24px; background: linear-gradient(135deg, #ede9fe, #ddd6fe); border: 2px solid #8b5cf6; border-radius: 12px; font-size: 15px; font-weight: 700; color: #5b21b6; cursor: pointer; transition: all 0.2s;">
                            <span style="font-size: 24px;">üìÆ</span>
                            <span>Redpack</span>
                        </button>
                    </div>
                </div>

                <!-- Loading state -->
                <div id="pickups-loading" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Cargando recolecciones...</p>
                </div>

                <!-- Pickups list by carrier -->
                <div id="pickups-list">
                    <!-- Dynamic content -->
                </div>

                <!-- Empty state -->
                <div id="pickups-empty" class="empty-state hidden">
                    <span class="empty-icon">üì¶</span>
                    <h3>No hay recolecciones</h3>
                    <p>No hay recolecciones programadas para esta fecha</p>
                </div>
            </section>

            <!-- Marketplace View -->
            <section id="marketplace-view" class="view">
                <div class="view-header">
                    <h2>üåé Mercado Libre Global Selling</h2>
                    <div id="ml-connection-badge">
                        <!-- Dynamic: Connected/Disconnected badge -->
                    </div>
                </div>

                <!-- Connection Panel (shown when disconnected) -->
                <div id="ml-connect-panel" class="hidden" style="text-align: center; padding: 60px 20px; background: white; border-radius: 16px; margin-bottom: 24px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">üîó</div>
                    <h3 style="font-size: 24px; margin: 0 0 12px 0;">Conectar con Mercado Libre</h3>
                    <p style="color: #6b7280; margin-bottom: 24px; max-width: 400px; margin-left: auto; margin-right: auto;">
                        Vincula tu cuenta de vendedor para publicar productos en Mexico, Brasil, Chile y Colombia.
                    </p>
                    <button onclick="connectMercadoLibre()" class="btn btn-primary" style="padding: 14px 32px; font-size: 16px;">
                        üöÄ Conectar Cuenta ML
                    </button>
                </div>

                <!-- Marketplace Dashboard (shown when connected) -->
                <div id="ml-dashboard" class="hidden">
                    <!-- Stats Summary -->
                    <div id="ml-stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                        <!-- Dynamic stats cards -->
                    </div>

                    <!-- Site Tabs -->
                    <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="site-tab active" data-site="all" onclick="filterBySite('all')" style="padding: 10px 20px; border-radius: 20px; border: 2px solid #e5e7eb; background: white; font-weight: 600; cursor: pointer;">
                            Todos
                        </button>
                        <button class="site-tab" data-site="MLM" onclick="filterBySite('MLM')" style="padding: 10px 20px; border-radius: 20px; border: 2px solid #e5e7eb; background: white; font-weight: 600; cursor: pointer;">
                            üá≤üáΩ Mexico
                        </button>
                        <button class="site-tab" data-site="MLB" onclick="filterBySite('MLB')" style="padding: 10px 20px; border-radius: 20px; border: 2px solid #e5e7eb; background: white; font-weight: 600; cursor: pointer;">
                            üáßüá∑ Brasil
                        </button>
                        <button class="site-tab" data-site="MLC" onclick="filterBySite('MLC')" style="padding: 10px 20px; border-radius: 20px; border: 2px solid #e5e7eb; background: white; font-weight: 600; cursor: pointer;">
                            üá®üá± Chile
                        </button>
                        <button class="site-tab" data-site="MCO" onclick="filterBySite('MCO')" style="padding: 10px 20px; border-radius: 20px; border: 2px solid #e5e7eb; background: white; font-weight: 600; cursor: pointer;">
                            üá®üá¥ Colombia
                        </button>
                        <div style="flex: 1;"></div>
                        <button onclick="disconnectMercadoLibre()" class="btn" style="color: #ef4444;">
                            Desconectar
                        </button>
                    </div>

                    <!-- Loading state -->
                    <div id="ml-loading" class="loading hidden">
                        <div class="spinner"></div>
                        <p>Cargando productos...</p>
                    </div>

                    <!-- Products Table -->
                    <div style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                    <th style="padding: 16px; text-align: left; width: 40px;">
                                        <input type="checkbox" id="ml-select-all" onchange="toggleSelectAll()">
                                    </th>
                                    <th style="padding: 16px; text-align: left;">Producto</th>
                                    <th style="padding: 16px; text-align: left;">Precio Local</th>
                                    <th style="padding: 16px; text-align: left;">Precio USD</th>
                                    <th style="padding: 16px; text-align: left;">Estado ML</th>
                                    <th style="padding: 16px; text-align: center;">Stock</th>
                                    <th style="padding: 16px; text-align: left;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="ml-products-body">
                                <!-- Dynamic rows -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Bulk Actions Bar -->
                    <div id="ml-bulk-actions" class="hidden" style="position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #1f2937; color: white; padding: 16px 24px; border-radius: 12px; display: flex; align-items: center; gap: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <span id="ml-selected-count" style="font-weight: 600;">0 seleccionados</span>
                        <button onclick="bulkPublishSelected()" class="btn btn-primary">
                            üöÄ Publicar Seleccionados
                        </button>
                        <button onclick="bulkSyncInventory()" class="btn" style="background: #374151; color: white;">
                            üîÑ Sincronizar Stock
                        </button>
                    </div>
                </div>
            </section>

            <!-- Combined Employee Portal View -->
            <section id="employee-portal-view" class="view">
                <div class="view-header">
                    <h2>üë• Portal Empleados</h2>
                    <div id="portal-header-actions">
                        <!-- Dynamic buttons based on active tab -->
                    </div>
                </div>

                <!-- Internal Tabs -->
                <div class="portal-tabs" style="display: flex; gap: 0; margin-bottom: 24px; background: #f3f4f6; border-radius: 12px; padding: 4px;">
                    <button class="portal-tab active" data-portal-tab="employees" onclick="switchPortalTab('employees')" style="flex: 1; padding: 12px 24px; border: none; background: white; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        üë• Empleados
                    </button>
                    <button class="portal-tab" data-portal-tab="tasks" onclick="switchPortalTab('tasks')" style="flex: 1; padding: 12px 24px; border: none; background: transparent; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; color: #6b7280;">
                        üìã Tareas
                    </button>
                </div>

                <!-- Employees Tab Content -->
                <div id="portal-employees-content" class="portal-tab-content">
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
                        <button class="btn btn-primary" onclick="openAddEmployeeModal()">
                            ‚ûï Agregar Empleado
                        </button>
                    </div>

                <!-- Stats Row -->
                <div id="employee-stats" class="stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                    <div class="stat-card">
                        <span class="stat-icon">üë•</span>
                        <div class="stat-content">
                            <span class="stat-value" id="total-employees-count">0</span>
                            <span class="stat-label">Total Empleados</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-icon">‚úÖ</span>
                        <div class="stat-content">
                            <span class="stat-value" id="active-employees-count">0</span>
                            <span class="stat-label">Activos</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-icon">‚è∏Ô∏è</span>
                        <div class="stat-content">
                            <span class="stat-value" id="inactive-employees-count">0</span>
                            <span class="stat-label">Inactivos</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-icon">üëî</span>
                        <div class="stat-content">
                            <span class="stat-value" id="manager-count">0</span>
                            <span class="stat-label">Gerentes</span>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="filters-bar" style="margin-bottom: 20px;">
                    <div class="filter-group">
                        <select id="employee-role-filter" onchange="filterEmployees()" class="filter-select">
                            <option value="">Todos los roles</option>
                            <option value="design">Dise√±ador</option>
                            <option value="production">Producci√≥n</option>
                            <option value="shipping">Env√≠os</option>
                            <option value="manager">Gerente</option>
                        </select>
                        <select id="employee-status-filter" onchange="filterEmployees()" class="filter-select">
                            <option value="">Todos los estados</option>
                            <option value="true">Activos</option>
                            <option value="false">Inactivos</option>
                        </select>
                    </div>
                    <div class="search-box">
                        <input type="text" id="employee-search" placeholder="Buscar empleado..." oninput="searchEmployees()">
                    </div>
                </div>

                <!-- Employees Table -->
                <div class="table-container" style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <table class="data-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                <th style="padding: 16px; text-align: left;">Empleado</th>
                                <th style="padding: 16px; text-align: left;">Email</th>
                                <th style="padding: 16px; text-align: left;">Rol</th>
                                <th style="padding: 16px; text-align: center;">Estado</th>
                                <th style="padding: 16px; text-align: left;">√öltimo acceso</th>
                                <th style="padding: 16px; text-align: center;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="employees-table-body">
                            <!-- Dynamic rows -->
                        </tbody>
                    </table>
                </div>
                </div><!-- End portal-employees-content -->

                <!-- Tasks Tab Content -->
                <div id="portal-tasks-content" class="portal-tab-content" style="display: none;">
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
                        <button class="btn btn-primary" onclick="openCreateTaskModal()">
                            ‚ûï Nueva Tarea
                        </button>
                    </div>

                <!-- Stats Row -->
                <div id="task-stats" class="stats-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px;">
                    <div class="stat-card">
                        <span class="stat-icon">üìä</span>
                        <div class="stat-content">
                            <span class="stat-value" id="total-tasks-count">0</span>
                            <span class="stat-label">Total</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-icon">‚è≥</span>
                        <div class="stat-content">
                            <span class="stat-value" id="pending-tasks-count">0</span>
                            <span class="stat-label">Pendientes</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-icon">üîÑ</span>
                        <div class="stat-content">
                            <span class="stat-value" id="inprogress-tasks-count">0</span>
                            <span class="stat-label">En Progreso</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-icon">‚úÖ</span>
                        <div class="stat-content">
                            <span class="stat-value" id="completed-tasks-count">0</span>
                            <span class="stat-label">Completadas</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-icon">üö´</span>
                        <div class="stat-content">
                            <span class="stat-value" id="blocked-tasks-count">0</span>
                            <span class="stat-label">Bloqueadas</span>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="filters-bar" style="margin-bottom: 20px;">
                    <div class="filter-group">
                        <select id="task-dept-filter" onchange="filterTasksList()" class="filter-select">
                            <option value="">Todos los departamentos</option>
                            <option value="design">Dise√±o</option>
                            <option value="production">Producci√≥n</option>
                            <option value="shipping">Env√≠os</option>
                        </select>
                        <select id="task-status-filter" onchange="filterTasksList()" class="filter-select">
                            <option value="">Todos los estados</option>
                            <option value="pending">Pendiente</option>
                            <option value="in_progress">En Progreso</option>
                            <option value="completed">Completada</option>
                            <option value="blocked">Bloqueada</option>
                            <option value="cancelled">Cancelada</option>
                        </select>
                        <select id="task-priority-filter" onchange="filterTasksList()" class="filter-select">
                            <option value="">Todas las prioridades</option>
                            <option value="urgent">Urgente</option>
                            <option value="high">Alta</option>
                            <option value="normal">Normal</option>
                            <option value="low">Baja</option>
                        </select>
                        <select id="task-employee-filter" onchange="filterTasksList()" class="filter-select">
                            <option value="">Todos los empleados</option>
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    <button class="btn-refresh" onclick="loadTasksData()">
                        üîÑ Actualizar
                    </button>
                </div>

                <!-- Tasks Table -->
                <div class="table-container" style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <table class="data-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                <th style="padding: 16px; text-align: left; width: 30%;">Tarea</th>
                                <th style="padding: 16px; text-align: left;">Departamento</th>
                                <th style="padding: 16px; text-align: left;">Asignado a</th>
                                <th style="padding: 16px; text-align: center;">Prioridad</th>
                                <th style="padding: 16px; text-align: center;">Estado</th>
                                <th style="padding: 16px; text-align: left;">Fecha l√≠mite</th>
                                <th style="padding: 16px; text-align: center;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tasks-table-body">
                            <!-- Dynamic rows -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="tasks-empty-state" class="empty-state hidden" style="text-align: center; padding: 60px 20px; background: white; border-radius: 16px; margin-top: 20px;">
                    <div style="font-size: 60px; margin-bottom: 16px;">üìã</div>
                    <h3 style="color: #374151; margin-bottom: 8px;">No hay tareas</h3>
                    <p style="color: #6b7280;">Las tareas aparecer√°n aqu√≠ cuando las crees</p>
                </div>
                </div><!-- End portal-tasks-content -->

            </section><!-- End employee-portal-view -->
        </div>
    </main>

    <!-- Employee Modal -->
    <div id="employee-modal" class="modal hidden">
        <div class="modal-backdrop" onclick="closeEmployeeModal()"></div>
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="employee-modal-title">Agregar Empleado</h3>
                <button class="btn-close" onclick="closeEmployeeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="employee-form" onsubmit="saveEmployee(event)">
                    <input type="hidden" id="employee-id">

                    <div class="form-group">
                        <label for="employee-name">Nombre completo *</label>
                        <input type="text" id="employee-name" required placeholder="Ej: Juan P√©rez">
                    </div>

                    <div class="form-group">
                        <label for="employee-email">Email *</label>
                        <input type="email" id="employee-email" required placeholder="empleado@empresa.com">
                    </div>

                    <div class="form-group" id="password-group">
                        <label for="employee-password">Contrase√±a *</label>
                        <input type="password" id="employee-password" placeholder="M√≠nimo 6 caracteres">
                        <small class="form-hint">Dejar vac√≠o para mantener la contrase√±a actual (al editar)</small>
                    </div>

                    <div class="form-group">
                        <label for="employee-role">Rol *</label>
                        <select id="employee-role" required>
                            <option value="">Seleccionar...</option>
                            <option value="design">Dise√±ador</option>
                            <option value="production">Producci√≥n</option>
                            <option value="shipping">Env√≠os</option>
                            <option value="manager">Gerente</option>
                        </select>
                    </div>
                    <!-- Hidden department field with default value -->
                    <input type="hidden" id="employee-department" value="production">

                    <div class="form-group">
                        <label for="employee-phone">Tel√©fono</label>
                        <input type="tel" id="employee-phone" placeholder="Opcional">
                    </div>

                    <div class="form-group" id="status-group" style="display: none;">
                        <label class="toggle-label">
                            <input type="checkbox" id="employee-active" checked>
                            <span>Cuenta activa</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEmployeeModal()">Cancelar</button>
                <button type="submit" form="employee-form" class="btn btn-primary" id="employee-submit-btn">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div id="reset-password-modal" class="modal hidden">
        <div class="modal-backdrop" onclick="closeResetPasswordModal()"></div>
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Restablecer Contrase√±a</h3>
                <button class="btn-close" onclick="closeResetPasswordModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="reset-password-employee-name" style="margin-bottom: 16px; color: #6b7280;"></p>
                <form id="reset-password-form" onsubmit="resetEmployeePassword(event)">
                    <input type="hidden" id="reset-password-employee-id">
                    <div class="form-group">
                        <label for="new-password">Nueva contrase√±a *</label>
                        <input type="password" id="new-password" required placeholder="M√≠nimo 6 caracteres" minlength="6">
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">Confirmar contrase√±a *</label>
                        <input type="password" id="confirm-password" required placeholder="Repetir contrase√±a">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeResetPasswordModal()">Cancelar</button>
                <button type="submit" form="reset-password-form" class="btn btn-primary">Restablecer</button>
            </div>
        </div>
    </div>

    <!-- Task Modal (Create/Edit) -->
    <div id="task-modal" class="modal hidden">
        <div class="modal-backdrop" onclick="closeTaskModal()"></div>
        <div class="modal-content task-modal-content">
            <div class="modal-header">
                <h3 id="task-modal-title">Nueva Tarea</h3>
                <button class="btn-close" onclick="closeTaskModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="task-form" onsubmit="saveTask(event)">
                    <input type="hidden" id="task-id">

                    <div class="form-group">
                        <label for="task-title">T√≠tulo <span class="required-asterisk">*</span></label>
                        <input type="text" id="task-title" required placeholder="Ej: Preparar dise√±o para cliente ABC">
                    </div>

                    <div class="form-group">
                        <label for="task-description">Descripci√≥n</label>
                        <textarea id="task-description" rows="3" placeholder="Agrega detalles adicionales, instrucciones o notas..."></textarea>
                    </div>

                    <!-- Hidden department field with default value -->
                    <input type="hidden" id="task-department" value="production">

                    <div class="form-group">
                        <label for="task-priority">Prioridad</label>
                        <select id="task-priority">
                            <option value="normal">Normal</option>
                            <option value="low">Baja</option>
                            <option value="high">Alta</option>
                            <option value="urgent">Urgente</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="task-assigned-to">Asignar a</label>
                            <select id="task-assigned-to">
                                <option value="">Sin asignar</option>
                                <!-- Populated dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="task-due-date">Fecha l√≠mite</label>
                            <input type="datetime-local" id="task-due-date">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="task-estimated-minutes">Tiempo estimado</label>
                        <div class="input-suffix-group">
                            <input type="number" id="task-estimated-minutes" min="0" placeholder="30">
                            <span class="input-suffix">minutos</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">Cancelar</button>
                <button type="submit" form="task-form" class="btn btn-primary" id="task-submit-btn">Guardar Tarea</button>
            </div>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div id="task-detail-modal" class="modal hidden">
        <div class="modal-backdrop" onclick="closeTaskDetailModal()"></div>
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="task-detail-title">Detalles de Tarea</h3>
                <button class="btn-close" onclick="closeTaskDetailModal()">&times;</button>
            </div>
            <div class="modal-body" id="task-detail-body">
                <!-- Populated dynamically -->
            </div>
            <div class="modal-footer" id="task-detail-footer">
                <button type="button" class="btn btn-secondary" onclick="closeTaskDetailModal()">Cerrar</button>
                <button type="button" class="btn btn-primary" id="edit-task-btn">Editar</button>
            </div>
        </div>
    </div>

    <!-- Material Detail Modal -->
    <div id="material-detail-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="material-modal-title">Material</h2>
                <button class="modal-close" onclick="closeMaterialDetail()">√ó</button>
            </div>
            <div class="modal-body" id="material-modal-body">
                <!-- Dynamic content -->
            </div>
        </div>
        <div class="modal-backdrop" onclick="closeMaterialDetail()"></div>
    </div>

    <!-- Add/Edit Material Modal (BOM) -->
    <div id="add-material-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="material-modal-title">Agregar Material</h2>
                <button class="modal-close" onclick="closeAddMaterialModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="material-form" onsubmit="saveMaterial(event)">
                    <input type="hidden" name="material_id" id="material_id">
                    <div style="display: grid; gap: 16px;">
                        <!-- Basic Info -->
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Nombre del Material *</label>
                                <input type="text" name="name" id="material_name" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">SKU</label>
                                <input type="text" name="sku" id="material_sku" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Descripci√≥n</label>
                            <textarea name="description" id="material_description" rows="2" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;"></textarea>
                        </div>

                        <!-- Unit Type -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Tipo de Unidad *</label>
                                <select name="unit_type" id="material_unit_type" required onchange="handleUnitTypeChange(this.value)" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                    <option value="">-- Seleccionar --</option>
                                    <option value="piece">Piezas (piece)</option>
                                    <option value="area">√Årea (cm¬≤)</option>
                                    <option value="weight">Peso (gramos)</option>
                                    <option value="length">Longitud (metros)</option>
                                    <option value="volume">Volumen (litros)</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Etiqueta de Unidad</label>
                                <input type="text" name="unit_label" id="material_unit_label" placeholder="ej: piezas, cm¬≤, gramos" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>

                        <!-- Pricing -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Costo por Unidad *</label>
                                <input type="number" name="cost_per_unit" id="material_cost_per_unit" required min="0" step="0.0001" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Tama√±o de Compra</label>
                                <input type="number" name="purchase_unit_size" id="material_purchase_unit_size" min="0" step="0.01" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Costo de Compra</label>
                                <input type="number" name="purchase_unit_cost" id="material_purchase_unit_cost" min="0" step="0.01" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>

                        <!-- Area Fields (for sheets like MDF) -->
                        <div id="area-fields" style="display: none;">
                            <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; border: 2px solid #bfdbfe;">
                                <h4 style="margin: 0 0 12px 0; color: #1e40af;">Dimensiones de Hoja/L√°mina</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ancho (cm)</label>
                                        <input type="number" name="sheet_width" id="material_sheet_width" min="0" step="0.01" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Alto (cm)</label>
                                        <input type="number" name="sheet_height" id="material_sheet_height" min="0" step="0.01" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Supplier Info -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Proveedor</label>
                                <input type="text" name="supplier_name" id="material_supplier_name" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">C√≥digo del Proveedor</label>
                                <input type="text" name="supplier_product_code" id="material_supplier_code" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>

                        <!-- Stock -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Stock Actual</label>
                                <input type="number" name="current_stock" id="material_current_stock" min="0" step="0.01" value="0" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Stock M√≠nimo</label>
                                <input type="number" name="min_stock_level" id="material_min_stock" min="0" step="0.01" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px; margin-top: 16px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">Guardar Material</button>
                            <button type="button" onclick="closeAddMaterialModal()" class="btn" style="flex: 1; background: #e5e7eb; color: #374151;">Cancelar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="modal-backdrop" onclick="closeAddMaterialModal()"></div>
    </div>

    <!-- Add Component Modal -->
    <div id="add-component-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Agregar Componente</h2>
                <button class="modal-close" onclick="closeAddComponentModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="component-form" onsubmit="saveComponent(event)">
                    <input type="hidden" name="product_id" id="component_product_id">
                    <input type="hidden" name="component_id" id="component_id">
                    <div style="display: grid; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Material *</label>
                            <select name="raw_material_id" id="component_material_id" required onchange="handleMaterialSelection(this.value)" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                <option value="">-- Seleccionar material --</option>
                            </select>
                        </div>

                        <div id="component-quantity-section">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Cantidad Necesaria *</label>
                            <input type="number" name="quantity_needed" id="component_quantity" required min="0" step="0.0001" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            <small id="unit-hint" style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;"></small>
                        </div>

                        <!-- Area-based fields -->
                        <div id="component-area-fields" style="display: none;">
                            <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; border: 2px solid #bfdbfe;">
                                <h4 style="margin: 0 0 12px 0; color: #1e40af;">Dimensiones de Pieza</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ancho (cm)</label>
                                        <input type="number" name="piece_width" id="component_piece_width" min="0" step="0.01" onchange="calculateAreaCost()" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Alto (cm)</label>
                                        <input type="number" name="piece_height" id="component_piece_height" min="0" step="0.01" onchange="calculateAreaCost()" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                    </div>
                                </div>
                                <div id="area-cost-preview" style="margin-top: 12px; padding: 12px; background: white; border-radius: 6px; font-size: 14px;"></div>
                            </div>
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Porcentaje de Desperdicio (%)</label>
                            <input type="number" name="waste_percentage" id="component_waste" min="0" max="100" step="0.01" value="5.00" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            <small style="color: #6b7280; font-size: 12px;">Desperdicio estimado por corte, merma, etc.</small>
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Notas</label>
                            <textarea name="notes" id="component_notes" rows="2" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;"></textarea>
                        </div>

                        <div style="display: flex; gap: 12px; margin-top: 16px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">Guardar Componente</button>
                            <button type="button" onclick="closeAddComponentModal()" class="btn" style="flex: 1; background: #e5e7eb; color: #374151;">Cancelar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="modal-backdrop" onclick="closeAddComponentModal()"></div>
    </div>

    <!-- Product Detail Modal -->
    <div id="product-detail-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="product-detail-title">Detalles del Producto</h2>
                <button class="modal-close" onclick="closeProductDetailModal()">√ó</button>
            </div>
            <div class="modal-body" id="product-detail-body">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
        <div class="modal-backdrop" onclick="closeProductDetailModal()"></div>
    </div>

    <!-- Invoice Upload Modal -->
    <div id="invoice-upload-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì∏ Upload Invoice</h2>
                <button class="modal-close" onclick="closeInvoiceUploadModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; padding: 40px; border: 3px dashed #d1d5db; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#6366f1'; this.style.background='#f0f9ff'" onmouseout="this.style.borderColor='#d1d5db'; this.style.background=''">
                        <input type="file" id="invoice-file-input" accept="image/*,.pdf,.heic,.HEIC" onchange="handleInvoiceFileSelect(event)" style="display: none;">
                        <div style="font-size: 48px; margin-bottom: 12px;">üìÑ</div>
                        <div style="font-weight: 600; margin-bottom: 8px;">Click to upload invoice image</div>
                        <div style="font-size: 14px; color: #6b7280;">or drag and drop</div>
                        <div style="font-size: 12px; color: #9ca3af; margin-top: 8px;">PNG, JPG, HEIC, PDF up to 50MB</div>
                    </label>
                </div>
                <div id="invoice-preview" style="margin-bottom: 20px; text-align: center;"></div>
                <button id="invoice-upload-btn" onclick="handleInvoiceUpload()" class="btn btn-success" style="width: 100%;" disabled>
                    Process Invoice
                </button>
            </div>
        </div>
        <div class="modal-backdrop" onclick="closeInvoiceUploadModal()"></div>
    </div>

    <!-- Invoice Review Modal -->
    <div id="invoice-review-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>üìã Review Invoice</h2>
                <button class="modal-close" onclick="closeInvoiceReviewModal()">√ó</button>
            </div>
            <div class="modal-body" id="invoice-review-body">
                <!-- Dynamic content -->
            </div>
        </div>
        <div class="modal-backdrop" onclick="closeInvoiceReviewModal()"></div>
    </div>

    <!-- Print Labels Modal -->
    <div id="print-labels-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üè∑Ô∏è Print Labels</h2>
                <button class="modal-close" onclick="closePrintLabelsModal()">√ó</button>
            </div>
            <div class="modal-body" id="print-labels-body">
                <!-- Dynamic content -->
            </div>
        </div>
        <div class="modal-backdrop" onclick="closePrintLabelsModal()"></div>
    </div>

    <!-- Quick Receive Modal -->
    <div id="quick-receive-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2>‚ö° Quick Receive Mode</h2>
                <button class="modal-close" onclick="closeQuickReceiveModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <!-- Left Panel: Scanner Input -->
                    <div>
                        <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="margin: 0 0 16px 0; font-size: 18px;">Scan Barcode</h3>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">Barcode</label>
                                <input
                                    type="text"
                                    id="quick-barcode-input"
                                    onkeypress="handleQuickReceiveScan(event)"
                                    placeholder="Scan or type barcode..."
                                    style="width: 100%; padding: 16px; border: 3px solid #3b82f6; border-radius: 8px; font-size: 20px; font-family: monospace; text-transform: uppercase;"
                                    autocomplete="off">
                            </div>
                            <div id="quick-material-info" style="margin-bottom: 16px;">
                                <!-- Material info appears here -->
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">Quantity</label>
                                <input
                                    type="number"
                                    id="quick-quantity-input"
                                    onkeypress="handleQuickReceiveQuantity(event)"
                                    placeholder="Enter quantity..."
                                    style="width: 100%; padding: 16px; border: 3px solid #10b981; border-radius: 8px; font-size: 20px;"
                                    step="0.01"
                                    autocomplete="off">
                            </div>
                            <div style="margin-top: 20px; padding: 16px; background: #fef3c7; border-radius: 8px; font-size: 14px;">
                                <strong>Instructions:</strong><br>
                                1. Scan barcode or type and press Enter<br>
                                2. Enter quantity and press Enter<br>
                                3. Repeat for next item
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel: Session History -->
                    <div>
                        <h3 style="margin: 0 0 16px 0; font-size: 18px;">Recent Transactions</h3>
                        <div id="quick-receive-history" style="max-height: 500px; overflow-y: auto;">
                            <!-- Transaction history appears here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop" onclick="closeQuickReceiveModal()"></div>
    </div>

    <!-- Receipt Upload Modal -->
    <div id="receipt-upload-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>üì§ Subir Recibo de Proveedor</h2>
                <button class="modal-close" onclick="closeReceiptUploadModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <label id="receipt-drop-zone" style="display: block; padding: 40px; border: 3px dashed #d1d5db; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#6366f1'; this.style.background='#f0f9ff'" onmouseout="this.style.borderColor='#d1d5db'; this.style.background=''">
                        <input type="file" id="receipt-file-input" accept="image/*,.pdf,.heic,.HEIC" onchange="handleReceiptFileSelect(event)" style="display: none;">
                        <div style="font-size: 48px; margin-bottom: 12px;">üßæ</div>
                        <div style="font-weight: 600; margin-bottom: 8px;">Arrastra tu recibo aqui o haz clic para seleccionar</div>
                        <div style="font-size: 14px; color: #6b7280;">PNG, JPG, HEIC, PDF hasta 15MB</div>
                    </label>
                </div>
                <div id="receipt-preview" style="margin-bottom: 20px; text-align: center; display: none;">
                    <img id="receipt-preview-img" src="" alt="Preview" style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <p id="receipt-file-name" style="margin: 8px 0 0 0; font-size: 14px; color: #6b7280;"></p>
                </div>
                <div id="receipt-analysis-status" style="display: none; text-align: center; padding: 20px;">
                    <div class="spinner" style="margin: 0 auto 12px;"></div>
                    <p style="margin: 0; font-weight: 600;">Analizando recibo con Claude AI...</p>
                    <p style="margin: 8px 0 0 0; font-size: 14px; color: #6b7280;">Esto puede tomar unos segundos</p>
                </div>
                <button id="receipt-analyze-btn" onclick="analyzeReceipt()" class="btn btn-primary" style="width: 100%;" disabled>
                    Analizar Recibo
                </button>
            </div>
        </div>
        <div class="modal-backdrop" onclick="closeReceiptUploadModal()"></div>
    </div>

    <!-- Receipt Review Modal -->
    <div id="receipt-review-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>üìã Revisar Datos del Recibo</h2>
                <button class="modal-close" onclick="closeReceiptReviewModal()">√ó</button>
            </div>
            <div class="modal-body" id="receipt-review-body">
                <!-- Dynamic content will be rendered here -->
            </div>
            <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                <button class="btn" onclick="closeReceiptReviewModal()">Cancelar</button>
                <button id="receipt-save-btn" class="btn btn-success" onclick="saveReceipt()">
                    Guardar Recibo
                </button>
            </div>
        </div>
        <div class="modal-backdrop" onclick="closeReceiptReviewModal()"></div>
    </div>

    <!-- Pickup Request Modal -->
    <div id="pickup-request-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="pickup-modal-title">Solicitar Recolecci√≥n</h3>
                <button class="modal-close" onclick="closePickupModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 24px;">
                    <div id="pickup-modal-carrier-icon" style="font-size: 48px; margin-bottom: 8px;">üì¶</div>
                    <div id="pickup-modal-carrier-name" style="font-size: 24px; font-weight: 700; color: #374151;">Estafeta</div>
                </div>

                <form id="pickup-request-form" onsubmit="submitPickupRequest(event)">
                    <input type="hidden" id="pickup-carrier" value="">

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">
                            üìÖ Fecha de Recolecci√≥n
                        </label>
                        <input type="date" id="pickup-date" required
                            style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px;">
                        <p style="margin: 6px 0 0 0; font-size: 13px; color: #6b7280;">
                            Por defecto: siguiente d√≠a h√°bil
                        </p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">
                                üïò Desde
                            </label>
                            <input type="time" id="pickup-time-from" value="09:00" required
                                style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">
                                üïï Hasta
                            </label>
                            <input type="time" id="pickup-time-to" value="18:00" required
                                style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px;">
                        </div>
                    </div>

                    <div id="pickup-pending-info" style="background: #fef3c7; padding: 16px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 8px;">
                            ‚è≥ Gu√≠as pendientes para esta paqueter√≠a:
                        </div>
                        <div id="pickup-pending-count" style="font-size: 32px; font-weight: 700; color: #f59e0b;">
                            0
                        </div>
                        <div id="pickup-pending-list" style="margin-top: 8px; font-size: 13px; color: #6b7280;">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <button type="button" onclick="closePickupModal()"
                            style="flex: 1; padding: 14px 24px; background: #f3f4f6; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; color: #374151; cursor: pointer;">
                            Cancelar
                        </button>
                        <button type="submit" id="pickup-submit-btn"
                            style="flex: 2; padding: 14px 24px; background: linear-gradient(135deg, #667eea, #764ba2); border: none; border-radius: 10px; font-size: 15px; font-weight: 600; color: white; cursor: pointer;">
                            üöÄ Solicitar Recolecci√≥n
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div class="modal-backdrop" onclick="closePickupModal()"></div>
    </div>

    <!-- Command Palette Modal (‚åòK) -->
    <div id="command-palette" class="command-palette hidden">
        <div class="command-palette-container">
            <div class="command-palette-header">
                <i data-lucide="search" class="command-search-icon"></i>
                <input
                    type="text"
                    id="command-palette-input"
                    class="command-palette-input"
                    placeholder="Buscar pedido, ejecutar comando, o preguntar a AI..."
                    autocomplete="off"
                    onkeydown="handleCommandPaletteKey(event)"
                    oninput="handleCommandSearch(this.value)"
                />
                <kbd class="kbd-close">ESC</kbd>
            </div>
            <div class="command-palette-body" id="command-palette-results">
                <div class="command-section">
                    <div class="command-section-title">Acciones R√°pidas</div>
                    <div class="command-item" data-action="new-quote" onclick="executeCommand('new-quote')">
                        <i data-lucide="file-text" class="command-icon"></i>
                        <span class="command-text">Nueva cotizaci√≥n</span>
                        <span class="command-hint">/quote</span>
                    </div>
                    <div class="command-item" data-action="pending-orders" onclick="executeCommand('pending-orders')">
                        <i data-lucide="clock" class="command-icon"></i>
                        <span class="command-text">Ver pedidos pendientes</span>
                        <span class="command-hint">/pending</span>
                    </div>
                    <div class="command-item" data-action="analytics" onclick="executeCommand('analytics')">
                        <i data-lucide="bar-chart-3" class="command-icon"></i>
                        <span class="command-text">Abrir Dashboard</span>
                        <span class="command-hint">/dashboard</span>
                    </div>
                    <div class="command-item" data-action="create-label" onclick="executeCommand('create-label')">
                        <i data-lucide="tag" class="command-icon"></i>
                        <span class="command-text">Crear gu√≠a de env√≠o</span>
                        <span class="command-hint">/ship</span>
                    </div>
                </div>
                <div class="command-section">
                    <div class="command-section-title">Navegaci√≥n</div>
                    <div class="command-item" data-action="nav-orders" onclick="executeCommand('nav-orders')">
                        <i data-lucide="clipboard-list" class="command-icon"></i>
                        <span class="command-text">Ir a Pedidos</span>
                    </div>
                    <div class="command-item" data-action="nav-inventory" onclick="executeCommand('nav-inventory')">
                        <i data-lucide="package" class="command-icon"></i>
                        <span class="command-text">Ir a Inventario</span>
                    </div>
                    <div class="command-item" data-action="nav-shipping" onclick="executeCommand('nav-shipping')">
                        <i data-lucide="truck" class="command-icon"></i>
                        <span class="command-text">Ir a Log√≠stica</span>
                    </div>
                </div>
                <div class="command-section command-ai-section">
                    <div class="command-section-title">
                        <i data-lucide="sparkles" class="ai-sparkle"></i> Preguntar a AI
                    </div>
                    <div class="command-item command-ai" data-action="ask-ai" onclick="executeCommand('ask-ai')">
                        <i data-lucide="message-circle" class="command-icon"></i>
                        <span class="command-text">Hacer pregunta al asistente...</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop command-backdrop" onclick="closeCommandPalette()"></div>
    </div>

    <!-- AI Assistant Chat Modal -->
    <div id="ai-chat-modal" class="ai-chat-modal hidden">
        <div class="ai-chat-container">
            <div class="ai-chat-header">
                <div class="ai-chat-title">
                    <div class="ai-avatar">
                        <i data-lucide="bot" class="icon"></i>
                    </div>
                    <div>
                        <h3>Asistente AXKAN</h3>
                        <span class="ai-status">En l√≠nea - Conoce todo sobre tu negocio</span>
                    </div>
                </div>
                <div class="ai-chat-actions">
                    <button class="ai-action-btn" onclick="clearAiChat()" title="Limpiar conversaci√≥n">
                        <i data-lucide="trash-2" class="icon-sm"></i>
                    </button>
                    <button class="ai-action-btn" onclick="closeAiChatModal()" title="Cerrar">
                        <i data-lucide="x" class="icon-sm"></i>
                    </button>
                </div>
            </div>
            <div class="ai-chat-body" id="ai-chat-messages">
                <!-- Welcome message -->
                <div class="ai-message assistant">
                    <div class="ai-message-avatar">
                        <i data-lucide="bot" class="icon-sm"></i>
                    </div>
                    <div class="ai-message-content">
                        <p>Soy tu asistente de AXKAN. ¬øEn qu√© puedo ayudarte?</p>
                        <div class="ai-suggestions">
                            <button class="ai-suggestion-btn" onclick="sendAiQuestion('¬øCu√°ntos pedidos tenemos pendientes?')">
                                <i data-lucide="clipboard-list" class="icon-xs"></i> Pedidos pendientes
                            </button>
                            <button class="ai-suggestion-btn" onclick="sendAiQuestion('¬øCu√°l fue el ingreso de este mes?')">
                                <i data-lucide="dollar-sign" class="icon-xs"></i> Ingresos del mes
                            </button>
                            <button class="ai-suggestion-btn" onclick="sendAiQuestion('Cotiza 100 imanes y 50 llaveros')">
                                <i data-lucide="file-text" class="icon-xs"></i> Nueva cotizaci√≥n
                            </button>
                            <button class="ai-suggestion-btn" onclick="sendAiQuestion('¬øCu√°les son los productos m√°s vendidos?')">
                                <i data-lucide="trophy" class="icon-xs"></i> Productos top
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="ai-chat-footer">
                <div id="ai-image-preview-bar" class="ai-image-preview-bar hidden"></div>
                <div class="ai-input-container">
                    <input type="file" id="ai-image-input" accept="image/*" multiple style="display:none" onchange="handleAiImageSelect(event)">
                    <button class="ai-attach-btn" onclick="document.getElementById('ai-image-input').click()" title="Adjuntar imagen">
                        <i data-lucide="image-plus" class="icon-sm"></i>
                    </button>
                    <textarea
                        id="ai-chat-input"
                        class="ai-chat-input"
                        placeholder="Escribe tu pregunta o pega una imagen..."
                        rows="1"
                        onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendAiMessage(); }"
                        oninput="this.style.height = 'auto'; this.style.height = Math.min(this.scrollHeight, 120) + 'px';"
                    ></textarea>
                    <button class="ai-send-btn" onclick="sendAiMessage()" id="ai-send-btn">
                        <i data-lucide="send" class="icon-sm"></i>
                    </button>
                </div>
                <p class="ai-disclaimer">
                    Consulto datos en tiempo real de tu base de datos
                </p>
            </div>
        </div>
        <div class="modal-backdrop" onclick="closeAiChatModal()"></div>
    </div>

    <!-- AI Mobile Button (visible on mobile only) -->
    <button class="ai-mobile-btn" onclick="openAiChatModal()" title="Asistente AI" aria-label="Abrir asistente AI">
        <i data-lucide="bot" class="icon">ü§ñ</i>
    </button>

    <!-- Daily Startup Alerts Modal -->
    <div id="startup-alerts-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 640px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); color: white; border-radius: 16px 16px 0 0;">
                <h2 id="startup-alerts-title" style="margin:0; font-size:18px;">Alertas del dia</h2>
                <button class="modal-close" onclick="closeStartupAlerts()" style="color: white; background: rgba(255,255,255,0.2);">&times;</button>
            </div>
            <div class="modal-body" id="startup-alerts-body" style="padding: 16px 20px; max-height: 420px; overflow-y: auto;">
                <!-- Populated dynamically -->
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center;">
                <button class="btn-secondary" onclick="openNotificationCenter(); closeStartupAlerts();" style="font-size: 13px;">
                    Ver Centro de Notificaciones
                </button>
                <button class="btn-primary" onclick="closeStartupAlerts()">
                    Entendido
                </button>
            </div>
        </div>
        <div class="modal-backdrop" onclick="closeStartupAlerts()"></div>
    </div>

    <script src="dashboard.js"></script>
    <script src="inventory.js"></script>
    <script src="prices.js"></script>
    <script src="shipping.js"></script>
    <script src="guias.js"></script>
    <script src="analytics.js"></script>
    <script src="calendar.js"></script>
    <script src="discounts.js"></script>
    <script src="ai-assistant.js"></script>
    <script src="marketplace.js"></script>
    <script src="employees.js"></script>
    <script src="tasks.js?v=2"></script>
    <script src="command-palette.js"></script>
    <!-- Initialize Lucide Icons -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
        // Re-initialize icons after dynamic content loads
        window.refreshIcons = () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };
    </script>
</body>
</html>
